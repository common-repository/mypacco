<?php
/*
Plugin Name: Mypacco
Plugin URI:  http://seller.mypacco.com
Description: Got a Parcel to Send? We will take care of the rest... We help retail brands grow with seamless, omni-channel commerce solutions. From digital commerce, development, integration, and support to physical operations all the way to your customer’s doorstep, we help you outpace the competition like no other service provider. We’re experts in shipping and distributing parcels, through integrating the network of prime schedule airfreight services with the services of leading global postal systems, We deliver the most cost effective, scalable and process managed solution in today’s marketplace.
Version:     0.9.1
Author:      Harshwardhan Kohad
Author URI:  https://in.linkedin.com/in/harshwardhan-kohad-014a8258
License:     GPL2
License URI: https://www.gnu.org/licenses/gpl-2.0.html
Date : 2016-09-01
*/

/*********************Set timezone*********************/

date_default_timezone_set('Asia/Kolkata');

/*********************End  - Set timezone*********************/

/*********************Global*********************/

//API url
//$api_url = 'http://localhost/api/api/api/';
//$api_url = 'http://sandboxapi.mypacco.com/api/';
$api_url = 'http://api.mypacco.com/api/';

//Mypacco running man icon 20*20
$mypacco_icon = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAADP0lEQVR42mNgGDZgpjED6508GdWbuYpmtwtUHG7nq7jfLVDyvlak5HO9UEn3TBoDK9GGPU2T5LpToFx2t1Dl1p1i9Vd3S9Rf3y3WeHuvROPt3WL1t3eL1G7fKlCJ/h/KwEzQMJDNd/NVsu4Wqb+5W6R6606h6i6gwUvuFqn03ylQbbpVqNp8p0jtEtDgBzdy5BUxDJg0aRJfQv18DkW/VnER607e27kqfHeL1VaANF3OlVVGV/+fgYHxTr5yONDl7+4WqLpgGNg9ebaiUlBHlIBH0xYBz+aFFQkRCtcL1NbeLlLdfL9AQQCbL+4UKTveA7rwTrFqJIakVmi9kJhv6xo+14Z/fG4Nf0S9Gk9HhCa82ZtluPtKoYwQNgPvF6lYAMP1BjA4MmBijAyeuewifp28Un7thmI+rcfFvFs/S/q1vVcJaLy3I8/uJNDbp4DeF8VmIDDWje4UqV+6la9SzhBdv4TPPa1fUjO8W0cltNNPIai7Ximsa5mgR9M3PrfGv1JedUcWpLsevFqgcf1KloIEVi/nKRsDI+UyMLbrGTLbtwgGVy3Us82crWcUO1VTK7bHRjqgba1sYOcNUe+WW5K+Lcscg/NO9yW4fzqTrRl4JUuU50aSCO/NNF6RGzniijdyZE3uFam2gFLB7UKVMIaOmbv5LQtXcVqG9nEaJs4TlfBrWyDp1/pc0KP5K59703dh75YHst41a5tifV5dK9R4DXTFDSC+c69E9eG9YrWn94o1XgCD4yswSW28WSwpwhBZtUzcOmeyiUZEb4J8cEcJv3vjX6Chb8R9WxcrBbUDk0E9E8hbt3IVLO4XqW0AGXinSPUUKD0Ck8rqOwUqs4GxnHcfFhy5wDC0TposZZjUqy8d0LGYFxy7jR8FPZs3Crg358v4tatADIUYTBC4lSziVonstgTGaoykb2uLiFfzezGflleiXi07gRHzVNC9cZ+od3O5THCzKlEGSqbN5AJqyAWmu/dAl70HJugPckGd/ZpRfRH6CZOShDybbkj5tyXKhBZyEmWggEO9gLBnc6Z0QHuxSnhPSmjtUuPgmqWqofWr2EDyOpETxBkYQpmJL5cc6lm4XOulQImaYUQAACg4SJ7L+4x6AAAAAElFTkSuQmCC';

/*********************End - Global*********************/

/*********************Functions*********************/

/*
    @purpose = This function is used to create table if not present
    @author = Harshwardhan Kohad
    @type = Internal
*/
function mypacco_ctable()
{
    global $wpdb;

    require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );

    /*For table : prefix.mypacco_setup*/
    $tbl_mypacco_setup = $wpdb->prefix.'mypacco_setup';
    if($wpdb->get_var("SHOW TABLES LIKE '$tbl_mypacco_setup'") != $tbl_mypacco_setup) {
        //table not in database. Create new table
        $charset_collate_mypacco_setup = $wpdb->get_charset_collate();

        $sql_mypacco_setup = "CREATE TABLE $tbl_mypacco_setup (
          id int(10) NOT NULL AUTO_INCREMENT,
          client_id VARCHAR(80) NOT NULL,
          client_secret VARCHAR(80) NOT NULL,
          access_token VARCHAR(80) NOT NULL,
          expires timestamp NOT NULL,
          currency_unit VARCHAR(80) NOT NULL,
          UNIQUE KEY id (id)
        ) $charset_collate_mypacco_setup;";

        dbDelta( $sql_mypacco_setup );

        /*Insert default value in prefix.mypacco_setup*/
        $insert_sql ="INSERT INTO $tbl_mypacco_setup (`currency_unit`) VALUES ('INR')";

        dbDelta($insert_sql);
    }

    /*For table : prefix.mypacco_warehouse*/
    $tbl_mypacco_warehouse = $wpdb->prefix.'mypacco_warehouse';
    if($wpdb->get_var("SHOW TABLES LIKE '$tbl_mypacco_warehouse'") != $tbl_mypacco_warehouse) {
         //table not in database. Create new table
         $charset_collate_mypacco_warehouse = $wpdb->get_charset_collate();

         $sql_mypacco_warehouse = "CREATE TABLE $tbl_mypacco_warehouse (
              `warehouse_id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'Auto incremental ID',
              `warehouse_code` varchar(50) DEFAULT NULL COMMENT 'unique code for each warehouse, will be autogenerated',
              `warehouse_name` varchar(50) DEFAULT NULL,
              `contact_person` varchar(50) DEFAULT NULL COMMENT 'warehouse contact person name',
              `mobile_no` bigint(10) DEFAULT NULL COMMENT 'warehouse mobile no',
              `email_id` varchar(50) DEFAULT NULL COMMENT 'warehouse email id',
              `address` varchar(500) DEFAULT NULL COMMENT 'warehouse address',
              `landmark` varchar(50) DEFAULT NULL COMMENT 'warehouse landmark',
              `pincode` varchar(50) DEFAULT NULL COMMENT 'warehouse pincode',
              `city` varchar(50) DEFAULT NULL COMMENT 'warehouse city',
              `state` varchar(50) DEFAULT NULL COMMENT 'warehouse state',
              `country` varchar(50) DEFAULT NULL COMMENT 'warehouse country',
              `created_on` datetime DEFAULT NULL COMMENT 'Record created date',
              `created_by` int(3) DEFAULT NULL COMMENT 'Record created by user',
              PRIMARY KEY (`warehouse_id`)
            ) $charset_collate_mypacco_warehouse;";

         dbDelta( $sql_mypacco_warehouse );
    }


    /*For table : prefix.mypacco_order_master*/
    $tbl_mypacco_order_master = $wpdb->prefix.'mypacco_order_master';
    if($wpdb->get_var("SHOW TABLES LIKE '$tbl_mypacco_order_master'") != $tbl_mypacco_order_master) {
         //table not in database. Create new table
         $charset_collate_mypacco_order_master = $wpdb->get_charset_collate();

         $sql_mypacco_order_master = "CREATE TABLE $tbl_mypacco_order_master (
              `order_id` int(20) NOT NULL AUTO_INCREMENT COMMENT 'Auto Increment Id',
              `mypacco_order_id` varchar(50) NOT NULL COMMENT 'Mypacco Order Id',
              `is_combined` bigint(1) DEFAULT '1' COMMENT 'Order Combine',
              `combined_order_no` varchar(50) DEFAULT NULL,
              `post_id` int(20) DEFAULT '0' COMMENT 'wp_post order ID',
              `seller_order_number` varchar(50) DEFAULT 'NULL' COMMENT 'seller order number',
              `transport_mode` tinyint(2) DEFAULT '1' COMMENT '1- Air, 2 - Surface RTS transport mode id',
              `payment_type` int(2) NOT NULL DEFAULT '0' COMMENT '1 - Prepaid, 2 - COD',
              `localization_type` int(2) DEFAULT '0' COMMENT '1 - Domestic, 2 - International',
              `item_quantity` int(5) DEFAULT NULL COMMENT 'item quantity',
              `currency_unit` enum('USD','INR') DEFAULT NULL COMMENT 'Currenct unit of parce_amount',
              `supplier_name` varchar(30) DEFAULT NULL COMMENT 'LSP name',
              `rts_date` datetime DEFAULT NULL COMMENT 'RTS date',
              `awb_number` varchar(30) DEFAULT 'NULL' COMMENT 'AWB Number from the Supplier',
              `rto_awb_number` varchar(30) DEFAULT NULL COMMENT 'RTO Awb number',
              `order_bouquet` int(2) DEFAULT '0' COMMENT 'Order bouquet',
              `status` int(2) DEFAULT '0' COMMENT 'Order status Id',
              `status_desc` varchar(50) DEFAULT 'NULL' COMMENT 'Order status description',
              `last_status_changed_date` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT 'Last status changed date and time',
              `seller_warehouse_code` varchar(50) DEFAULT NULL COMMENT 'seller warehouse code',
              `delivery_date` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
              `delivery_fullname` varchar(100) DEFAULT 'NULL',
              `delivery_email` varchar(256) DEFAULT 'NULL',
              `delivery_mobile` varchar(100) DEFAULT 'NULL',
              `delivery_address` text,
              `delivery_pincode` varchar(20) DEFAULT NULL,
              `delivery_city` varchar(100) DEFAULT NULL,
              `delivery_state` varchar(100) DEFAULT NULL,
              `delivery_country` varchar(100) DEFAULT NULL,
              `is_canceled` int(2) DEFAULT '0' COMMENT '0 -  not canceled, 1 - canceled.',
              `is_deleted` int(2) DEFAULT '0' COMMENT 'Is Order Deleted or not? 0 = Not deleted, 1 = deleted',
              `created_on` datetime NOT NULL COMMENT 'Order Creation date',
              `created_by` int(10) DEFAULT '0' COMMENT 'Order created by user',
              PRIMARY KEY (`order_id`)
            )  $charset_collate_mypacco_order_master;";

         dbDelta( $sql_mypacco_order_master );
    }

    /*For table : prefix.mypacco_order_item_master*/
    $tbl_mypacco_order_item_master = $wpdb->prefix.'mypacco_order_item_master';
    if($wpdb->get_var("SHOW TABLES LIKE '$tbl_mypacco_order_item_master'") != $tbl_mypacco_order_item_master) {
         //table not in database. Create new table
         $charset_collate_mypacco_order_item_master = $wpdb->get_charset_collate();

         $sql_mypacco_order_item_master = "CREATE TABLE $tbl_mypacco_order_item_master (
              `order_item_id` int(20) NOT NULL AUTO_INCREMENT COMMENT 'Auto Increment Id',
              `order_id` int(20) NOT NULL COMMENT 'Order Id',
              `post_id` int(20) NOT NULL COMMENT 'post id use as tempariry combined id',
              `mypacco_order_id` varchar(100) DEFAULT NULL COMMENT 'Mypacco ID',
              `item_title` varchar(100) DEFAULT NULL COMMENT 'Item title',
              `parcel_desc` varchar(200) DEFAULT '-' COMMENT 'Description of the parcel.',
              `item_quantity` int(5) DEFAULT NULL COMMENT 'item quantity',
              `length` float(10,2) DEFAULT '0.00' COMMENT 'IN CMS',
              `width` float(10,2) DEFAULT '0.00' COMMENT 'IN CMS',
              `height` float(10,2) DEFAULT '0.00' COMMENT 'IN CMS',
              `weight` float(10,2) DEFAULT '0.00' COMMENT 'Weight from seller / customer',
              `volumetric_weight` float DEFAULT NULL COMMENT 'Volumetric Weight in Kg',
              `final_weight` float DEFAULT NULL COMMENT 'Final weight in Kg used to assign the lsp (surface or air) to the order.',
              `base_price` decimal(10,2) DEFAULT '0.00' COMMENT 'item base price',
              `shipp_handling_charges` decimal(10,2) DEFAULT '0.00' COMMENT 'Shipping & Handling Charges',
              `other_charges` decimal(10,2) DEFAULT '0.00' COMMENT 'vat tax amount , Packaging charges',
              `parcel_amount` float(10,2) DEFAULT '0.00' COMMENT 'Parcel actual cost (base_price + shipp_handling_charges)',
              `currency_unit` enum('USD','INR') DEFAULT NULL COMMENT 'Currenct unit of parce_amount',
              PRIMARY KEY (`order_item_id`)
            ) $charset_collate_mypacco_order_item_master;";

         dbDelta( $sql_mypacco_order_item_master );
    }
}

//add_action( string $tag, callable $function_to_add, int $priority = 10, int $accepted_args = 1 )
add_action('wp_before_admin_bar_render','mypacco_ctable');

/*
    @purpose = This function is used to display menu
    @author = Harshwardhan Kohad
    @type = External
*/
function mypacco_menu()
{
    global $mypacco_icon;

    // This is the menu on the side
    add_menu_page('Mypacco', 'Mypacco', 'manage_options', 'mypacco-menu', 'mypacco_index',$mypacco_icon);

    add_submenu_page( 'mypacco-menu', 'Track Orders', 'Track Orders', 'manage_options', 'mypacco-track-orders', 'mypacco_track_orders');
    add_submenu_page( 'mypacco-menu', 'Validate Pincode', 'Validate Pincode', 'manage_options', 'mypacco-validate-pincode', 'mypacco_validate_pincode');
    add_submenu_page( 'mypacco-menu', 'Orders', 'Orders', 'manage_options', 'mypacco-orders', 'mypacco_orders');
    add_submenu_page( 'mypacco-menu', 'Manage Warehouse', 'Manage Warehouse', 'manage_options', 'mypacco-manage-warehouse', 'mypacco_manage_warehouse');
    add_submenu_page( 'mypacco-menu', 'Configuration', 'Configuration', 'manage_options', 'mypacco-config', 'mypacco_config');

    // These are the hidden pages
    add_submenu_page( 'mypacco-menu', 'Add Warehouse', NULL, 'manage_options', 'mypacco_add_warehouse', 'mypacco_add_warehouse');
    add_submenu_page( 'mypacco-menu', 'Edit Order', NULL, 'manage_options', 'mypacco_edit_order', 'mypacco_edit_order');
    add_submenu_page( 'mypacco-menu', 'Add Order', NULL, 'manage_options', 'mypacco_add_order', 'mypacco_add_order');

    /* Note : How do you add a WordPress admin page without adding it to the menu?
        add_submenu_page with parent slug = null

        OR

        add_submenu_page with menu title = null

        add_submenu_page(
              null            // -> Set to null - will hide menu link
            , 'Page Title'    // -> Page Title
            , 'Menu Title'    // -> Title that would otherwise appear in the menu
            , 'administrator' // -> Capability level
            , 'menu_handle'   // -> Still accessible via admin.php?page=menu_handle
            , 'page_callback' // -> To render the page
        );
    */
}
add_action('admin_menu', 'mypacco_menu');

/*
    @purpose = This function is used to display index for the plugin
    @author = Harshwardhan Kohad
    @type = External
    @desc = This is the first page that is displayed when the menu is clicked
*/
function mypacco_index()
{
    echo '<p>&nbsp;</p>';
    //echo '<p><img src="http://mypacco.com/assets/images/mypacco-logo.png"></p>';
    echo '<img src="' . plugins_url( 'assets/images/woocommerce_module.png', __FILE__ ) . '" > ';

    echo '<p><h1>Got a Parcel to Send? We will take care of the rest... </h1></p>';

    echo '<p>We help retail brands grow with seamless, omni-channel commerce solutions. From digital commerce, development, integration, and support to physical operations all the way to your customer’s doorstep, we help you outpace the competition like no other service provider. We’re experts in shipping and distributing parcels, through integrating the network of prime schedule airfreight services with the services of leading global postal systems, We deliver the most cost effective, scalable and process managed solution in today’s marketplace.</p>';

    echo '<p><a href="http://www.mypacco.com">Read More...</a></p>';

    echo '<div class="wrap"><div id="icon-options-general" class="icon32"><br></div>
    <h2>To get started!!</h2></div>';

    echo '<p>1) Register on <a href="http://seller.mypacco.com/auth/registration" target="_blank">http://seller.mypacco.com</a>.</p>';
    echo '<p>2) Create Client Id & Client Secret.</p>';
    echo '<p>3) Add Client Id & Client secret in plugin config.</p>';
    echo '<p>4) Make sure Woocommerce plugin is installed & active.</p>';
}

/*
    @purpose = This function is used to display track orders page
    @author = Harshwardhan Kohad
    @type = External
*/
function mypacco_track_orders()
{
    echo '<div class="wrap"><h1>Track Orders</h1>';

    //Check if woocommerce is active
    if ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) )
    {
        global $wpdb;
        $table_name = $wpdb->prefix . "mypacco_setup";
        $retrieve_data1 = $wpdb->get_results( "SELECT * FROM $table_name WHERE id = 1" );

        $client_id = (!empty($retrieve_data1[0]->client_id)) ? $retrieve_data1[0]->client_id : '';
        $client_secret = (!empty($retrieve_data1[0]->client_secret)) ? $retrieve_data1[0]->client_secret : '';
        $currency_unit = (!empty($retrieve_data1[0]->currency_unit)) ? $retrieve_data1[0]->currency_unit : '';

        //Check if cilent id & clinet secrect is updated in plugin configuration
        if($client_id != '' && $client_secret != '')
        {
            $nonce = wp_create_nonce("track_order_nonce");
            echo '<div id="data_loading" style="display:none;"><div class="modal-backdrop1 fade in"></div><div class="loading">Please wait while we process your request... <br/><br/><img src="' . plugins_url( 'assets/images/circular_preload_blue_35_35.gif', __FILE__ ) . '" style="border:0px" ></div></div>';
            echo '<div style="margin: 8px 0 0;">';
                echo "<form id='track_order' action='".admin_url('admin-ajax.php')."' method='post' class='form-inline'>";
                    echo "<div class='form-group'>";
                        echo '<input id="trackingNo" class="track-input form-control validate[required]" placeholder="Tracking Number" autocomplete="off" name="trackingNo" required="" type="text" size="40">';
                        echo '<input id="nonce" class="track-input" name="nonce" type="hidden" value="'.$nonce.'">';
                    echo '</div> ';
                    echo "<input type='button' id='track_order_submit' name='track_order_submit' value='Track' class='btn btn-info'/>";
                echo "</form>";
            echo '</div>';

            echo '<div id="track_data" style="margin: 25px 0px;"></div>';
        }
        else
        {
            echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Add Client Id & Client secret in plugin config.</strong></div>';
        }
    }
    else
    {
        echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Please make sure Woocommerce plugin is installed & active.</strong></div>';
    }
}

/*
    @purpose = This function is used to display serach pincode page
    @author = Rahul Sharma
    @type = External
*/
function mypacco_validate_pincode()
{
    echo '<div class="wrap"><h1>Validate Pincode</h1>';

    //Check if woocommerce is active
    if ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) )
    {
        global $wpdb;
        $table_name = $wpdb->prefix . "mypacco_setup";
        $retrieve_data1 = $wpdb->get_results( "SELECT * FROM $table_name WHERE id = 1" );

        $client_id = (!empty($retrieve_data1[0]->client_id)) ? $retrieve_data1[0]->client_id : '';
        $client_secret = (!empty($retrieve_data1[0]->client_secret)) ? $retrieve_data1[0]->client_secret : '';
        $currency_unit = (!empty($retrieve_data1[0]->currency_unit)) ? $retrieve_data1[0]->currency_unit : '';

        //Check if cilent id & clinet secrect is updated in plugin configuration
        if($client_id != '' && $client_secret != '')
        {
             echo '<div id="data_loading" style="display:none;"><div class="modal-backdrop1 fade in"></div><div class="loading">Please wait while we process your request... <br/><br/><img src="' . plugins_url( 'assets/images/circular_preload_blue_35_35.gif', __FILE__ ) . '" style="border:0px" ></div></div>';
            echo '<div style="margin: 8px 0 0;">';
                echo "<form id='search_pincode' action='".admin_url('admin-ajax.php')."' method='post' class='form-inline'>";
                    echo "<div class='form-group'>";
                        echo '<b>Pincode</b>&nbsp;&nbsp;<input id="pincodeNo"  style="width:200px;margin-left:44px;" class="form-control validate[required]" placeholder="Search Pincode" autocomplete="off" name="pincodeNo" type="text"></div><br><br>';
                        echo '<div class="form-group"><b>Transport Type</b>&nbsp;&nbsp;<select style="width:200px;" id="transport_mode" class="form-control validate[required]" autocomplete="off" name="transport_mode">
                        <option value="">--Select--</option>
                        <option value="1">Air</option>
                        <option value="2">Surface</option>
                        </select></div><br><br>';
                        echo '<div class="form-group"><b>Transaction</b>&nbsp;&nbsp;&nbsp;<select style="width:200px;margin-left:18px;" id="payment_type" class="form-control validate[required]" autocomplete="off" name="payment_type">
                        <option value="">--Select--</option>
                        <option value="1">Prepaid</option>
                        <option value="2">COD</option>
                        </select>';
                    echo '</div><br><br>';
                    echo "<input type='button' id='search_pincode_submit' name='search_pincode_submit' value='Search' class='btn btn-info'/>";
                echo "</form>";
            echo '</div>';

            echo '<div id="search_data" style="margin: 25px 0px;"></div>';
        }
        else
        {
            echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Add Client Id & Client secret in plugin config.</strong></div>';
        }
    }
    else
    {
        echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Please make sure Woocommerce plugin is installed & active.</strong></div>';
    }
}

/*
    @purpose = This function is used to display process orders page
    @author = Harshwardhan Kohad
    @type = External
*/
function mypacco_orders()
{
    //Check if woocommerce is active
    if ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) )
    {
        global $wpdb;
        $table_name = $wpdb->prefix . "mypacco_setup";
        $retrieve_data1 = $wpdb->get_results( "SELECT * FROM $table_name WHERE id = 1" );

        $client_id = (!empty($retrieve_data1[0]->client_id)) ? $retrieve_data1[0]->client_id : '';
        $client_secret = (!empty($retrieve_data1[0]->client_secret)) ? $retrieve_data1[0]->client_secret : '';
        $currency_unit = (!empty($retrieve_data1[0]->currency_unit)) ? $retrieve_data1[0]->currency_unit : '';

        //Check if cilent id & clinet secrect is updated in plugin configuration
        if($client_id != '' && $client_secret != '')
        {
            /*Get API data from db*/
            $setup_table_name = $wpdb->prefix . "mypacco_setup";
            $ware_data = $wpdb->get_results( "SELECT * FROM $setup_table_name" );
            if(empty($ware_data)){
                $setup_error = '<div style="background-color:#FF0000;">Client ID and Client secret not added. Please add <a class="page-title-action" href="'.admin_url('admin.php?page=mypacco_config').'"> Click Here..</a> </div>';
            }else{$setup_error = '';}
            /* Get Warehouse Data */
            $table_name = $wpdb->prefix . "mypacco_warehouse";
            $ware_data = $wpdb->get_results( "SELECT * FROM $table_name" );
            if(empty($ware_data)){
                $ware_error = '<div style="background-color:#FF0000;">Warehouse not added. Please add warehouse <a class="page-title-action" href="'.admin_url('admin.php?page=mypacco_add_warehouse').'"> Click Here..</a> </div>';
            }else{$ware_error = '';}
            echo '<div class="wrap">';
            echo $ware_error;
            echo'<h1>Orders <a class="page-title-action" href="'.admin_url('admin.php?page=mypacco_add_order').'">Add Order</a></h1>';
            echo '';
            /*echo '<div style="margin: 8px 0 0;">';
            echo 'Yahoo';
            echo '</div>';*/
            echo '<div id="data_loading" style="display:none;"><div class="modal-backdrop1 fade in"></div><div class="loading">Please wait while we process your request... <br/><br/><img src="' . plugins_url( 'assets/images/circular_preload_blue_35_35.gif', __FILE__ ) . '" style="border:0px"></div></div>';
            echo '<div class="stepy-tab">';
            echo '<ul id="default-titles" class="stepy-titles clearfix">';
                echo '<li id="default-title-0" class="current-step">';
                    echo '<div onclick="getOrders(1, 0);">Unship Single</div>';
                    echo '<span> </span>';
                echo '</li>';
                echo '<li id="default-title-5">';
                    echo '<div onclick="getOrders(5, 5);">Unship Combine</div>';
                    echo '<span> </span>';
                echo '</li>';
                echo '<li id="default-title-1">';
                    echo '<div onclick="getOrders(2, 1);">Inprogress</div>';
                    echo '<span> </span>';
                echo '</li>';
                echo '<li id="default-title-2">';
                    echo '<div onclick="getOrders(3, 2);">Processed</div>';
                    echo '<span> </span>';
                echo '</li>';
                echo '<li id="default-title-3">';
                    echo '<div onclick="getOrders(4, 3);">Non Serviceable</div>';
                    echo '<span> </span>';
                echo '</li>';
            echo '</ul>';
            echo '</div>';
            echo '<div id="viewOrders" style="display:none"></div>';
            echo '<div id="viewMessage" style="display:none"></div>';
            /* Modal : Select Warehouse for RTS Orders */
            echo '<div aria-hidden="true" aria-labelledby="viewreqdocsmodalLabel" role="dialog" tabindex="-1" id="viewmodal" class="modal fade">
                    <div class="modal-backdrop fade in" style="height: 100%;"></div>
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close pull-right" data-dismiss="modal" aria-hidden="false">&times;</button>
                                <h4 class="modal-title">Select Item & Warehouse</h4>
                            </div>
                            <div id="modelView">

                            </div>
                        </div>
                    </div>

                </div>';
            /* End Modal  */
            /* Modal : View Order Data */
            echo '<div aria-hidden="true" aria-labelledby="viewordermodalLabel" role="dialog" tabindex="-1" id="viewordermodal" class="modal fade">
                    <div class="modal-backdrop fade in" style="height: 100%;"></div>
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close pull-right" data-dismiss="modal" aria-hidden="false">&times;</button>
                                <h4 class="modal-title">View Order</h4>
                            </div>
                            <div id="orderView">

                            </div>
                        </div>
                    </div>

                </div>';
            /* End Modal  */
            echo '</div>';
        }
        else
        {
            echo '<div class="wrap"><h1>Orders</h1>';
            echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Add Client Id & Client secret in plugin config.</strong></div>';
        }
    }
    else
    {
        echo '<div class="wrap"><h1>Orders</h1>';
        echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Please make sure Woocommerce plugin is installed & active.</strong></div>';
    }
}


/*
    @purpose = This function is used to display add order by manual form page
    @author = Rahul Sharma
    @type = External
*/
function mypacco_add_order()
{
    global $wpdb;
    /*Get data from db*/
    $table_name = $wpdb->prefix . "mypacco_warehouse";
    $ware_data = $wpdb->get_results( "SELECT * FROM $table_name" );
    if(empty($ware_data)){
        $ware_error = '<div style="background-color:#FF0000;">Warehouse not added. Please add warehouse <a class="page-title-action" href="'.admin_url('admin.php?page=mypacco_add_warehouse').'"> Click Here..</a> </div>';
    }else{$ware_error = '';}
    echo '<div id="data_loading" style="display:none;"><div class="modal-backdrop1 fade in"></div><div class="loading">Please wait while we process your request... <br/><br/><img src="' . plugins_url( 'assets/images/circular_preload_blue_35_35.gif', __FILE__ ) . '" style="border:0px" ></div></div>';
    echo '<div class="wrap"><h1>Add Order</h1>';
    echo '<div style="margin: 8px 0 0;">';
    echo $ware_error;
    echo "<form id='order-form' action='".admin_url('admin-ajax.php')."' method='post'>";
        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
            echo '<h4>Delivery Detail</h4>';
                echo '<div class="panel-body" id="p_scents">';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="order_no">Order No</label>';
                    echo '<input type="text" name="order_no" id="order_no" class="form-control validate[required]" autofocus>';
                    echo '<label for="email_id">Delivery Email</label>';
                    echo '<input type="text" name="email_id" id="email_id" class="form-control validate[required,custom[email]]">';
                    echo '<label for="city">City</label>';
                    echo '<input type="text" name="city" readonly id="city" class="form-control validate[required]">';
                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="delivery_name">Delivery Name</label>';
                    echo '<input type="text" name="delivery_name" id="delivery_name" class="form-control validate[required]">';
                    echo '<label for="pincode">Pincode</label>';
                    echo '<input type="text" name="pincode" id="pincode" class="form-control validate[required,custom[number],minSize[6]]" maxlength="6">';
                    echo '<label for="state">State</label>';
                    echo '<input type="text" name="state" readonly id="state" class="form-control validate[required]">';
                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="mobile_no">Delivery Mobile</label>';
                    echo '<input type="text" name="mobile_no" id="mobile_no" class="form-control validate[required,custom[number], maxsize[10]]">';
                    echo '<div id="validationEmailMSG"></div>';
                    echo '<input type="hidden" id="validateEmail" value="0" />';
                    echo '<label for="warehouse">Warehouse</label>';
                    echo '<select name="warehouse" id="warehouse" class="form-control validate[required]">';
                        echo '<option value="">-Select-</option>';
                         if(!empty($ware_data)){
                         foreach($ware_data AS $Data){
                            echo '<option value="'.$Data->warehouse_code.'">'.$Data->warehouse_code.'('.$Data->warehouse_name.')</option>';
                         } }
                    echo '</select>';
                    echo '<label for="country">Country</label>';
                    echo '<input type="text" name="country" readonly id="country" class="form-control validate[required]">';
                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="add">Address</label>';
                    echo '<textarea style="resize: none;" id="address" name="address" rows="3" cols="30" class="form-control validate[required]">';
                    echo '</textarea>';

                    echo '</div>';

                echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
            echo '<h4>Order Detail</h4>';
                echo '<div class="panel-body" id="p_scents">';
                    echo '<div class="col-lg-3">';
                    echo '<label for="height">Height</label>';
                    echo '<input type="text" name="height" id="height" onblur="valweight();" class="form-control validate[required,custom[number]]">';
                    echo '<label for="weight">Weight</label>';
                    echo '<input type="text" name="weight" id="weight" class="form-control validate[required,custom[number]]">';
                    echo '<label for="item_title">Item Title</label>';
                    echo '<input type="text" name="item_title" id="item_title" class="form-control validate[required]">';
                    echo '</div>';
                    echo '<div class="col-lg-3">';
                    echo '<label for="width">Width</label>';
                    echo '<input type="text" name="width" onblur="valweight();" id="width" class="form-control validate[required,custom[number]]">';
                    echo '<label for="base_price">Base Price</label>';
                    echo '<input type="text" name="base_price" id="base_price" class="form-control validate[required,custom[number]]">';
                    echo '<label for="trans_mode">Transport Mode</label>';
                    echo '<select name="trans_mode" id="trans_mode" class="form-control validate[required]">';
                    echo '<option value="">-Select-</option>';
                    echo '<option value="1">Air</option>';
                    echo '<option value="2">Surface</option>';
                    echo '</select>';
                    echo '</div>';
                    echo '<div class="col-lg-3">';
                    echo '<label for="length">Length</label>';
                    echo '<input type="text" name="length" id="length" onblur="valweight();" class="form-control validate[required,custom[number]]">';
                    echo '<label for="total_price">Total Price</label>';
                    echo '<input type="text" name="total_price" id="total_price" class="form-control validate[required,custom[number]]">';
                    echo '<label for="pay_mode">Payment Mode</label>';
                    echo '<select name="pay_mode" id="pay_mode" class="form-control validate[required]">';
                    echo '<option value="">-Select-</option>';
                    echo '<option value="1">Prepaid</option>';
                    echo '<option value="2">COD</option>';
                    echo '</select>';
                    echo '</div>';
                    echo '<div class="col-lg-3">';
                    echo '<label for="val_weight">Val. Weight</label>';
                    echo '<input type="text" name="val_weight" readonly id="val_weight" class="form-control validate[required]">';
                    echo '<label for="item_quantity">Item Quantity</label>';
                    echo '<input type="text" name="item_quantity" id="item_quantity" class="form-control validate[required]">';
                    echo '</div>';
                echo '</div>';
            echo '</section>';
        echo '</div>';

        echo '</div>';

        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
                echo '<div class="panel-body" id="p_scents">';
                    echo '<div class="col-lg-6">';
                    echo '<div id="validationMSG" style="display:none"></div>';
                    echo '</div>';
                    echo '<div class="col-lg-6" id="msgManageOrder">';
                    echo '<input style="float:right;" type="button" value="Submit" class="btn btn-info" id="addorder" name="addorder"/>';
                    echo '</div>';
                echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '</div>';
    echo "</form>";
    echo '</div>';
    echo '</div>';
}


/*
    @purpose = This function is used to display manage warehouse page
    @author = Harshwardhan Kohad
    @type = External
*/
function mypacco_manage_warehouse()
{
    //Check if woocommerce is active
    if ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) )
    {
        global $wpdb;
        $table_name = $wpdb->prefix . "mypacco_setup";
        $retrieve_data1 = $wpdb->get_results( "SELECT * FROM $table_name WHERE id = 1" );

        $client_id = (!empty($retrieve_data1[0]->client_id)) ? $retrieve_data1[0]->client_id : '';
        $client_secret = (!empty($retrieve_data1[0]->client_secret)) ? $retrieve_data1[0]->client_secret : '';
        $currency_unit = (!empty($retrieve_data1[0]->currency_unit)) ? $retrieve_data1[0]->currency_unit : '';

        $html = '';

        /*Get data from db*/
        $table_name = $wpdb->prefix . "mypacco_warehouse";
        $retrieve_data = $wpdb->get_results( "SELECT * FROM $table_name" );

    //    $html .= '<div class="tablenav top"></div>';
        if($client_id != '' && $client_secret != ''){
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped" id="warehouse_tbl">';
        $html .= '<thead><tr><th scope="col">Warehouse Code</th><th scope="col">Name</th><th scope="col">Contact Person</th><th scope="col">Mobile No.</th><th scope="col">Email Id</th><th scope="col">Address</th></tr></thead>';


        $html .= '<tbody id="the-list">';
        foreach($retrieve_data as $wh_data)
        {
            $html .= '<tr>';
            $html .= '<th scope="row">'.$wh_data->warehouse_code.'</th>';
            $html .= '<th scope="row">'.$wh_data->warehouse_name.'</th>';
            $html .= '<th scope="row">'.$wh_data->contact_person.'</th>';
            $html .= '<th scope="row">'.$wh_data->mobile_no.'</th>';
            $html .= '<th scope="row">'.$wh_data->email_id.'</th>';
            $html .= '<th scope="row">'.$wh_data->address.', '.$wh_data->landmark.', '.$wh_data->city.', '.$wh_data->state.', '.$wh_data->pincode.'</th>';
            $html .= '</tr>';
        }
        $html .= '</tbody><tfoot><tr><th scope="col">Warehouse Code</th><th scope="col">Name</th><th scope="col">Contact Person</th><th scope="col">Mobile No.</th><th scope="col">Email Id</th><th scope="col">Address</th></tr></tfoot></table>';


        echo '<div class="wrap"><h1>Manage Warehouse <a class="page-title-action" href="'.admin_url('admin.php?page=mypacco_add_warehouse').'">Add Warehouse</a></h1>';

        echo $html;
        echo '</div>';
        }
        else
        {
            echo '<div class="wrap"><h1>Manage Warehouse</h1></div>';
            echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Add Client Id & Client secret in plugin config.</strong></div>';
        }
    }
    else
    {
        echo '<div class="wrap"><h1>Manage Warehouse</h1></div>';
        echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Please make sure Woocommerce plugin is installed & active.</strong></div>';
    }
}

/*
    @purpose = This function is used to display add warehouse page
    @author = Harshwardhan Kohad
    @type = External
*/
function mypacco_add_warehouse()
{
    global $wpdb;
    $table_name = $wpdb->prefix . "mypacco_setup";
    $retrieve_data = $wpdb->get_results( "SELECT * FROM $table_name WHERE id = 1" );

    $client_id = (!empty($retrieve_data[0]->client_id)) ? $retrieve_data[0]->client_id : '';
    $client_secret = (!empty($retrieve_data[0]->client_secret)) ? $retrieve_data[0]->client_secret : '';
    $currency_unit = (!empty($retrieve_data[0]->currency_unit)) ? $retrieve_data[0]->currency_unit : '';
    echo '<div class="wrap"><h1>Add Warehouse</h1>';
    echo '<div style="margin: 8px 0 0;">';
    echo '<div id="data_loading" style="display:none;"><div class="modal-backdrop1 fade in"></div><div class="loading">Please wait while we process your request... <br/><br/><img src="' . plugins_url( 'assets/images/circular_preload_blue_35_35.gif', __FILE__ ) . '"   style="border:0px" ></div></div>';
    if($client_id != '' && $client_secret != ''){
    echo "<form id='add_warehouse' action='".admin_url('admin-ajax.php')."' method='post'>";
        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
                echo '<div class="panel-body" id="p_scents">';

                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="name">Name</label>';
                    echo '<input type="text" name="warehouse_name" id="warehouse_name" class="form-control validate[required]" autofocus>';
                    echo '<label for="contact_person">Contact Person</label>';
                    echo '<input type="text" name="contact_person" id="contact_person" class="form-control validate[required]">';
                    echo '<label for="city">City</label>';
                    echo '<input type="text" name="city" readonly id="city" class="form-control validate[required]">';
                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="mobile_number">Mobile Number</label>';
                    echo '<input type="text" name="mobile_no" id="mobile_no" class="form-control validate[required,custom[number], maxsize[10]]">';
                    echo '<label for="pincode">Pincode</label>';
                    echo '<input type="text" name="pincode" id="pincode"  class="form-control validate[required,custom[number],minSize[6]]" maxlength="6">';
                    echo '<label for="state">State</label>';
                    echo '<input type="text" name="state" readonly id="state" class="form-control validate[required]">';
                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="email_id">Email</label>';
                    echo '<input type="text" name="email_id" id="email_id" class="form-control validate[required,custom[email]]">';
                    echo '<div id="validationEmailMSG"></div>';
                    echo '<input type="hidden" id="validateEmail" value="0" />';
                    echo '<label for="landmark">Landmark</label>';
                    echo '<input type="text" name="landmark" id="landmark" class="form-control validate[required]">';
                    echo '<label for="country">Country</label>';
                    echo '<input type="text" name="country" readonly id="country" class="form-control validate[required]">';
                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="add">Address</label>';
                    echo '<textarea style="resize: none;" id="address" name="address" rows="3" cols="30" class="form-control validate[required]">';
                    echo '</textarea>';
                    echo '</div>';

                echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '</div>';

        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
                echo '<div class="panel-body" id="p_scents">';
                    echo '<div class="col-lg-6">';
                    echo '<div id="validationMSG" style="display:none"></div>';
                    echo '</div>';
                    echo '<div class="col-lg-6" id="msgManageOrder">';
                    echo '<input style="float:right;" type="button" value="Submit" class="btn btn-info" id="addwarebtn" name="addwarebtn"/>';
                    echo '</div>';
                echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '</div>';
    echo "</form>";
    }else{
        echo '<div style="padding:8px; width:350px;" class="alert alert-block alert-danger fade in col-md-4"><h2>To get started!!</h2><strong>Add Client Id & Client secret in plugin config.</strong></div>';
    }
    echo '</div>';
    echo '</div>';
}

/*
    @purpose = This function is used to display config orders page
    @author = Harshwardhan Kohad
    @type = External
*/
function mypacco_config()
{
    global $wpdb;

    /*Get data from db*/

    $table_name = $wpdb->prefix . "mypacco_setup";
    $retrieve_data = $wpdb->get_results( "SELECT * FROM $table_name WHERE id = 1" );

    $client_id = (!empty($retrieve_data[0]->client_id)) ? $retrieve_data[0]->client_id : '';
    $client_secret = (!empty($retrieve_data[0]->client_secret)) ? $retrieve_data[0]->client_secret : '';
    $currency_unit = (!empty($retrieve_data[0]->currency_unit)) ? $retrieve_data[0]->currency_unit : '';

    echo '<div class="wrap"><h1>Mypacco Plugin Configuration</h1>';
    echo '<div style="margin: 8px 0 0;">';
    echo "<form id='mypacco_config' action='".admin_url('admin-ajax.php')."' method='post'>";
        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
                echo '<div class="panel-body" id="p_scents">';
                    echo '<div class="form-group col-lg-6">';
                        echo '<label for="client_id">Client ID*</label>';
                        echo '<input type="text" name="client_id" id="client_id" class="form-control" autofocus value="' . $client_id . '">';

                        echo '<label for="client_secret">Client Secret*</label>';
                        echo '<input type="text" name="client_secret" id="client_secret" class="form-control"  autofocus value="' . $client_secret . '">';
                    echo '</div>';

                    $chk1 = '';
                    $chk2 = '';

                    switch ($currency_unit) {
                        case 'INR':
                            $chk1 = 'checked';
                            break;
                        case 'USD':
                            $chk2 = 'checked';
                            break;
                        default:
                            $chk1 = 'checked';
                            $chk2 = '';
                    }

                    echo '<div class="form-group">';
                        echo '<div class="col-lg-3">';
                            echo '<input id="currency_unit" '.$chk1.' class="rd-checkbox"  type="radio" value="INR" name="currency_unit">';
                            echo '<label for="currency_unit" class="rd-label">INR</label>';
                        echo '</div>';
                        echo '<div class="col-lg-3">';
                            echo '<input id="currency_unit1" '.$chk2.' type="radio" class="rd-checkbox" value="USD" name="currency_unit">';
                            echo '<label for="currency_unit1" class="rd-label">USD</label>';
                        echo '</div>';
                    echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '</div>';

        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
                echo '<div class="panel-body" id="p_scents">';
                    echo '<div class="col-lg-6">';
                    echo '<div id="validationMSG" style="display:none"></div>';
                    echo '</div>';
                    echo '<div class="col-lg-6" id="msgMypaccoConfig">';
                    echo '<input style="float:right;" type="button" value="Submit" class="btn btn-info" id="mypaccoconfigbtn" name="mypaccoconfigbtn"/>';
                    echo '</div>';
                echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '</div>';
    echo "</form>";
    echo '</div>';
    echo '</div>';

}

/*
    @purpose = This function is used to get accesstoken
    @author = Harshwardhan Kohad
    @type = Internal
*/
function getAccessToken()
{
    global $wpdb;

    /*Get data from db*/
    $table_name = $wpdb->prefix . "mypacco_setup";
    $retrieve_data = $wpdb->get_results( "SELECT * FROM $table_name WHERE id = 1" );

    $client_id = (!empty($retrieve_data[0]->client_id)) ? $retrieve_data[0]->client_id : '';
    $client_secret = (!empty($retrieve_data[0]->client_secret)) ? $retrieve_data[0]->client_secret : '';
    $access_token = (!empty($retrieve_data[0]->access_token)) ? $retrieve_data[0]->access_token : '';
    $expires = (!empty($retrieve_data[0]->expires)) ? $retrieve_data[0]->expires : '';

    $return_access_token = '';

    if($access_token == '' || is_null($access_token))
    {
        //Get accesstoken using curl
        $return_access_token = genaccesstokenarray($client_id,$client_secret);
    }
    else
    {
        $cdate = date('Y-m-d H:i:s');

        if(strtotime($expires) > strtotime($cdate))
        {
            //If accesstoken is valid and not expired
            $return_access_token = json_encode(array('error'=>0,'msg'=>'', 'access_token'=>$access_token));
        }
        else
        {
            //Get accesstoken using curl
            $return_access_token = genaccesstokenarray($client_id,$client_secret);
        }
    }

    return $return_access_token;
}

/*
    @purpose = This function is used to generate accesstoken using curl
    @author = Harshwardhan Kohad
    @type = Internal
*/
function genaccesstokenarray($client_id,$client_secret)
{
    global $api_url;

    global $wpdb;

    //Create array
    $send_at_array['access_token'] = '';
    $send_at_array['data'][0]['client_id'] = $client_id;
    $send_at_array['data'][0]['client_secret'] = $client_secret;

    //Encode array to json
    $send_at_array = json_encode($send_at_array, JSON_PRETTY_PRINT);

    //get data using curl
    $acess_token_url = $api_url.'getAccessToken';

    $at_response = curl_req($acess_token_url, $send_at_array);

    $rt_access_token = '';

    //Process response
    if(!empty($at_response))
    {
        $at_response = json_decode($at_response, true);
        //Get Error if client_id, client_secret not correct
        $error = $at_response['Error']['1001'];
        //get access token from response
        $access_token = $at_response['Data']['access_token'];

        if(!empty($access_token))
        {
            $rt_access_token = json_encode(array('error'=>0,'msg'=>'', 'access_token'=>$access_token));
            $rt_access_token1 = $access_token;

            $table_name = $wpdb->prefix . "mypacco_setup";

            $update_data_array = array(
                'access_token' => $rt_access_token1,
                'expires' => date('Y-m-d H:i:s', strtotime('+59 minutes'))
            );

            $update_where_array = array( 'id' => 1 );

            //Update time and access token to db
            $wpdb->update($table_name, $update_data_array, $update_where_array);
        }
        else
        {
            $rt_access_token = json_encode(array('error'=>1,'msg'=>$error, 'access_token'=>''));

        }
    }
    else
    {
        $rt_access_token = json_encode(array('error'=>1,'msg'=>'', 'access_token'=>''));

    }

    return $rt_access_token;
}


/*
    @purpose = This function is used
    @author = Harshwardhan Kohad
    @type = Internal
*/
/*function track_order_action()
{
    if ( !wp_verify_nonce( $_REQUEST['nonce'], "track_order_nonce")) {
      exit("Invalid Input");
    }

    $result['type'] = "success";
    $result['trackingNo'] = $_REQUEST["trackingNo"];

    if(!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {
        $result = json_encode($result);
        echo $result;
    }
        else {
        header("Location: ".$_SERVER["HTTP_REFERER"]);
    }

   die();
}

add_action("track_order_action", "track_order_action");*/

/*
    @purpose = This function is used to register jquery
    @author = Harshwardhan Kohad
    @type = Internal
*/
function mypacco_script_enqueuer()
{
    global $api_url;

    /*Ajax url's*/
    $url_array = array(
        'mypacco_order_redirect_url' => admin_url('admin.php?page=mypacco-orders'),

         'track_order_url' => admin_url('admin-ajax.php?action=track_api_call'),
        'validate_pincode_url' => admin_url('admin-ajax.php?action=validate_pincode_api_call'),
        'add_warehouse_url' => admin_url('admin-ajax.php?action=add_warehouse_api_call'),
        'mypacco_config_url' => admin_url('admin-ajax.php?action=mypacco_config_db_call'),

        'mypacco_order_url' => admin_url('admin-ajax.php?action=mypacco_manage_orders'),
        'mypacco_add_new_order_url' => admin_url('admin-ajax.php?action=mypacco_add_new_order'),
        'mypacco_Rts_Orders_url' => admin_url('admin-ajax.php?action=Rts_Orders'),
        'mypacco_Orders_status_url' => admin_url('admin-ajax.php?action=reaload_status'),
        'edit_order_url' => admin_url('admin-ajax.php?action=edit_order_submit'),
        'mypacco_Rts_Orders_submit_url' => admin_url('admin-ajax.php?action=submit_rts_Orders'),
        'mypacco_view_order_url' => admin_url('admin-ajax.php?action=mypacco_ajax_view_order'),
        'mypacco_Orders_cancel_url' => admin_url('admin-ajax.php?action=orders_cancel'),
        'add_order_form_url' => admin_url('admin-ajax.php?action=add_order_form'),
        'mypacco_Orders_documents_url' => admin_url('admin-ajax.php?action=get_document'),
        'mypacco_Rts_combine_Orders_url' => admin_url('admin-ajax.php?action=Rts_combine_Orders'),
        'mypacco_combine_Rts_Orders_submit_url' => admin_url('admin-ajax.php?action=submit_combine_rts_Orders')


    );

    /****************JS***************/
    wp_register_script( "mypacco_script", WP_PLUGIN_URL.'/mypacco/assets/js/mypacco_script.js', array('jquery') );
    wp_localize_script( 'mypacco_script', 'mypacco_script_array', $url_array);

    wp_enqueue_script( 'jquery' );
    wp_enqueue_script( 'mypacco_script' );

    //Validation
    wp_register_script( "mypacco_validation_script", WP_PLUGIN_URL.'/mypacco/assets/js/jquery.validationEngine.js');
    wp_enqueue_script( 'mypacco_validation_script');
    wp_register_script( "mypacco_validation_en_script", WP_PLUGIN_URL.'/mypacco/assets/js/jquery.validationEngine-en.js');
    wp_enqueue_script( 'mypacco_validation_en_script');
    // Bootstrap
    wp_register_script( "mypacco_bootstrap_en_script", WP_PLUGIN_URL.'/mypacco/assets/js/mypacco_bootstrap_script.js');
    wp_enqueue_script( 'mypacco_bootstrap_en_script');

    //Datatable
    wp_register_script( "mypacco_datatable1_script", 'https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js');
    wp_enqueue_script( "mypacco_datatable1_script");
    wp_register_script( "mypacco_datatable2_script", WP_PLUGIN_URL.'/mypacco/assets/js/datatable/jquery.dataTables.delay.min.js');
    wp_enqueue_script( "mypacco_datatable2_script");
    wp_register_script( "mypacco_datatable3_script", 'https://cdn.datatables.net/buttons/1.1.0/js/dataTables.buttons.min.js');
    wp_enqueue_script( "mypacco_datatable3_script");
    wp_register_script( "mypacco_datatable4_script", WP_PLUGIN_URL.'/mypacco/assets/js/datatable/dataTables.buttons.min.js');
    wp_enqueue_script( "mypacco_datatable4_script");
    wp_register_script( "mypacco_datatable5_script", 'https://cdn.datatables.net/buttons/1.1.0/js/buttons.flash.min.js');
    wp_enqueue_script( "mypacco_datatable5_script");
    wp_register_script( "mypacco_datatable6_script", 'https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js');
    wp_enqueue_script( "mypacco_datatable6_script");
    wp_register_script( "mypacco_datatable7_script", 'https://cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/pdfmake.min.js');
    wp_enqueue_script( "mypacco_datatable7_script");
    wp_register_script( "mypacco_datatable8_script", 'https://cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js');
    wp_enqueue_script( "mypacco_datatable8_script");
    wp_register_script( "mypacco_datatable9_script", 'https://cdn.datatables.net/buttons/1.1.0/js/buttons.html5.min.js');
    wp_enqueue_script( "mypacco_datatable9_script");
    wp_register_script( "mypacco_datatable10_script", 'https://cdn.datatables.net/buttons/1.1.0/js/buttons.print.min.js');
    wp_enqueue_script( "mypacco_datatable10_script");
    wp_register_script( "mypacco_datatable11_script", WP_PLUGIN_URL.'/mypacco/assets/js/datatable/DT_bootstrap.js');
    wp_enqueue_script( "mypacco_datatable11_script");

    /* Boot Box Alert */
    wp_register_script( "mypacco_bootbox_script", WP_PLUGIN_URL.'/mypacco/assets/js/datatable/bootbox.js');
    wp_enqueue_script( "mypacco_bootbox_script");
    // Bootstrap
   //wp_register_script('mypacco_bootstrap', '//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js');
   //wp_enqueue_script('mypacco_bootstrap');
    /****************End JS***************/

    /****************CSS***************/
    wp_register_style('mypacco_styles', WP_PLUGIN_URL.'/mypacco/assets/css/mypacco_styles.css');
    wp_enqueue_style('mypacco_styles');

     /********Font Awesome CSS***************/
    wp_register_style('mypacco_font_styles', 'https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css');
    wp_enqueue_style('mypacco_font_styles');

    //Validation
    wp_register_style('mypacco_validation_styles', WP_PLUGIN_URL.'/mypacco/assets/css/validationEngine.jquery.css');
    wp_enqueue_style('mypacco_validation_styles');

    //Datatable
    wp_register_style('mypacco_datatable1_styles', WP_PLUGIN_URL.'/mypacco/assets/css/datatable/buttons.dataTables.min.css');
    wp_enqueue_style('mypacco_datatable1_styles');
    wp_register_style('mypacco_datatable2_styles', WP_PLUGIN_URL.'/mypacco/assets/css/datatable/DT_bootstrap.css');
    wp_enqueue_style('mypacco_datatable2_styles');
    wp_register_style('mypacco_datatable3_styles', WP_PLUGIN_URL.'/mypacco/assets/css/datatable/demo_table.css');
    wp_enqueue_style('mypacco_datatable3_styles');
    wp_register_style('mypacco_datatable4_styles', WP_PLUGIN_URL.'/mypacco/assets/css/datatable/demo_page.css');
    wp_enqueue_style('mypacco_datatable4_styles');

    // Bootstrap
    //wp_register_style('mypacco_bootstrap', '//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css');
    //wp_enqueue_style('mypacco_bootstrap');
    /****************End CSS***************/
}

add_action( 'init', 'mypacco_script_enqueuer' );



/*
    @purpose = This function is used to make curl request
    @author = Harshwardhan Kohad
    @type = Internal
*/
function curl_req($surl,$send_array)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $surl);
    //curl_setopt($ch, CURLOPT_HEADER, 1);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
    curl_setopt($ch, CURLOPT_POSTFIELDS, $send_array);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, TRUE);
    curl_setopt( $ch, CURLOPT_SSL_VERIFYPEER, false);
    $response = curl_exec($ch);
    /*curl_close($ch);
    return $response;*/
    if(curl_error($ch))
    {
        echo 'error:' . curl_error($ch);
    }
    else
    {
        curl_close($ch);
        return $response;
    }
}

/*
    @purpose = This function is used to make curl request , process the response and return json
    @author = Harshwardhan Kohad
    @type = Internal
*/
function track_api_call()
{
    //    wp_send_json($resp); used to return json
    global $api_url;

    if(empty($_REQUEST['trackingNo']))
    {
        $t_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>Invalid Tracking No.</strong></div>';
        $resp = array('msg' => 'fail', 'html' => $t_e_msg);
        wp_send_json($resp) ;
        exit;
    }

    //Get tracking details
    $tracking_no_array = array();
    $tracking_no_array[] = $_REQUEST['trackingNo'];

    $access_token = getAccessToken();
    $access = json_decode($access_token, true);

    if($access['error'] == 1){
        $t_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>'.$access['msg'].'</strong></div>';
        $resp = array('msg' => 'fail', 'html' => $t_e_msg);
        wp_send_json($resp) ;
        exit;
    }

    //Create array
    $send_t_array['access_token'] = $access['access_token'];
    $send_t_array['data'][0]['tracking_number'] = $tracking_no_array;

    //Encode array to json
    $send_t_array = json_encode($send_t_array, JSON_PRETTY_PRINT);

    //get data using curl
    $tracking_url = $api_url.'trackOrder';

    $t_response = curl_req($tracking_url, $send_t_array);

    if(!empty($t_response))
    {
        $t_response = json_decode($t_response);

        $t_error = $t_response->Data[0]->Error;

        if(empty($t_error))
        {
            $html = '<ul class="subsubsub"><li class="all">Mypacco Order Id : '.$t_response->Data[0]->MyPaccoId.' | </li> <li class="wc-processing"> AWB No. : '.$t_response->Data[0]->AWBNumber.'</li></ul>';

            $html .= '<div class="tablenav top"></div>';

            $html .= '<table class="wp-list-table widefat fixed striped posts">';
            $html .= '<thead><tr><th scope="col">Order Status</th><th scope="col">Location</th><th scope="col">Date</th></tr></thead>';
            $t_status = $t_response->Data[0]->TrackingStatus;

            $html .= '<tbody id="the-list">';
            foreach($t_status as $status)
            {
                $html .= '<tr>';
                $html .= '<th scope="row">'.$status->status.'</th><th scope="row">'.$status->location.'</th><th scope="row">'.$status->date.'</th>';
                $html .= '</tr>';
            }
            $html .= '</tbody><tfoot><tr><th scope="col">Order Status</th><th scope="col">Location</th><th scope="col">Date</th></tr></tfoot></table>';

            $resp = array('msg' => 'success', 'html' => $html);
            wp_send_json($resp) ;
            exit;
        }
        else
        {
            $t_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>'.$t_response->Data[0]->ErrorMessage.'</strong></div>';
            $resp = array('msg' => 'fail', 'html' => $t_e_msg);
            wp_send_json($resp) ;
            exit;
        }
    }

}
add_action( 'wp_ajax_track_api_call', 'track_api_call' );

/*
    @purpose = This function is used to make curl request , process the response and return json
    @author = Harshwardhan Kohad
    @type = Internal
*/
function validate_pincode_api_call()
{
    //    wp_send_json($resp); used to return json
    global $api_url;

    $access_token = getAccessToken();

    $access = json_decode($access_token, true);

    if($access['error'] == 1){
        $t_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>'.$access['msg'].'</strong></div>';
        $resp = array('msg' => 'fail', 'html' => $t_e_msg);
        wp_send_json($resp) ;
        exit;
    }

    //Create array
    $send_p_array['access_token'] = $access['access_token'];
    $send_p_array['data'][0]['pincode'] = $_REQUEST['pincode'];
    $send_p_array['data'][0]['transport_mode'] = isset($_REQUEST['transport_mode'])?$_REQUEST['transport_mode']:1;
    $send_p_array['data'][0]['payment_type'] = isset($_REQUEST['payment_type'])?$_REQUEST['payment_type']:1;

    //Encode array to json
    $send_p_array = json_encode($send_p_array, JSON_PRETTY_PRINT);

    //get data using curl
    $validate_pincode_url = $api_url.'validatePincode';

    $vp_response = curl_req($validate_pincode_url, $send_p_array);

    if(!empty($vp_response))
    {
        $vp_response = json_decode($vp_response);

        $vp_error = $vp_response->Error;

        if(empty($vp_error))
        {
            $r_array = array();
            $r_array['msg'] = 'success';
            $r_array['city_name'] = $vp_response->Data[0]->city_name;
            $r_array['state_name'] = $vp_response->Data[0]->state_name;
            $r_array['country_name'] = $vp_response->Data[0]->country_name;

            $resp = $r_array;

            wp_send_json($resp) ;
            exit;
        }

        else
        {
            $t_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>'.$vp_response->Message.'</strong></div>';
            $resp = array('msg' => 'fail', 'html' => $t_e_msg);
            wp_send_json($resp) ;
            exit;
        }
    }
}
add_action( 'wp_ajax_validate_pincode_api_call', 'validate_pincode_api_call' );


/*
    @purpose = This function is used to make curl request , process the response and return json
    @author = Harshwardhan Kohad
    @type = Internal
*/
function add_warehouse_api_call()
{
    // wp_send_json($resp); used to return json
    global $api_url, $wpdb;

    $warehouse_name = $_POST['warehouse_name'];
    $contact_person = $_POST['contact_person'];
    $city = $_POST['city'];
    $mobile_no = $_POST['mobile_no'];
    $pincode = $_POST['pincode'];
    $state = $_POST['state'];
    $email_id = $_POST['email_id'];
    $landmark = $_POST['landmark'];
    $country = (strtoupper($_POST['country']) == 'INDIA') ? 'IN' : 'US';
    $address = $_POST['address'];

    //Check If warehouse already exist
    $table_name = $wpdb->prefix . "mypacco_warehouse";
    $retrieve_data = $wpdb->get_results( "SELECT warehouse_id FROM $table_name WHERE warehouse_name = '".$warehouse_name."'");

    if ($retrieve_data)
    {
        $aw_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>Warehouse Already exists!!!!</strong></div>';
        $resp = array('msg' => 'fail', 'html' => $aw_e_msg);
        wp_send_json($resp) ;
        exit;
    }

    //Get tracking details
    $add_warehouse_array = array(
        'warehouse_name' => $warehouse_name,
        'contact_person' => $contact_person,
        'mobile_no' => $mobile_no,
        'email_id' => $email_id,
        'landmark' => $landmark,
        'address' => $address,
        'city' => $city,
        'pincode' => $pincode,
        'state' => $state,
        'country' => $country
    );

    $access_token = getAccessToken();

    $access = json_decode($access_token, true);

    if($access['error'] == 1){
        $t_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>'.$access['msg'].'</strong></div>';
        $resp = array('msg' => 'fail', 'html' => $t_e_msg);
        wp_send_json($resp) ;
        exit;
    }

    //Create array
    $send_aw_array['access_token'] = $access['access_token'];
    $send_aw_array['data'][0]['warehouse'][0] = $add_warehouse_array;

    //Encode array to json
    $send_aw_array = json_encode($send_aw_array, JSON_PRETTY_PRINT);

    //get data using curl
    $add_warehouse_url = $api_url.'addWarehouse';

    $aw_response = curl_req($add_warehouse_url, $send_aw_array);

    if(!empty($aw_response))
    {
        $aw_response = json_decode($aw_response);

        $aw_error = $aw_response->Error;

        if(empty($aw_error))
        {
            $table_name = $wpdb->prefix . "mypacco_warehouse";

            $add_warehouse_array['warehouse_code'] = $aw_response->Data[0]->warehouse_code;

            //Update time and access token to db
            $wpdb->insert($table_name, $add_warehouse_array);

            $aw_e_msg = '<div class="alert alert-block alert-success fade in" style="width:500px;"><strong>'.$aw_response->Message.'</strong></div>';

            $resp = array('msg' => 'success', 'html' => $aw_e_msg);
            wp_send_json($resp) ;
            exit;
        }
        else
        {
            $aw_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>'.$aw_response->Message.'</strong></div>';
            $resp = array('msg' => 'fail', 'html' => $aw_e_msg);
            wp_send_json($resp) ;
            exit;
        }
    }


}
add_action( 'wp_ajax_add_warehouse_api_call', 'add_warehouse_api_call' );

/*
    @purpose = This function is used to make curl request , process the response and return json
    @author = Harshwardhan Kohad
    @type = Internal
*/
function mypacco_config_db_call()
{
    //    wp_send_json($resp); used to return json
    global $wpdb;

    $client_id = (!empty($_POST['client_id'])) ? $_POST['client_id'] : '';
    $client_secret = (!empty($_POST['client_secret'])) ? $_POST['client_secret'] : '';
    $currency_unit = (!empty($_POST['currency_unit'])) ? $_POST['currency_unit'] : '';

    if(empty($client_id) || empty($client_secret))
    {
        $t_e_msg = '<div class="alert alert-block alert-danger fade in" style="width:500px;"><strong>All fields are mandatory</strong></div>';
        $resp = array('msg' => 'fail', 'html' => $t_e_msg);
        wp_send_json($resp) ;
        exit;
    }
    else
    {
        $table_name = $wpdb->prefix . "mypacco_setup";

        $update_data_array = array(
            'client_id' => $client_id,
            'client_secret' => $client_secret,
            'currency_unit' => $currency_unit
        );

        $update_where_array = array( 'id' => 1 );

        //Update time and access token to db
        $wpdb->update($table_name, $update_data_array, $update_where_array);

        $t_e_msg = '<div class="alert alert-block alert-success fade in" style="width:500px;"><strong>Data Updated Successfully!!!</strong></div>';
        $resp = array('msg' => 'success', 'html' => $t_e_msg);
        wp_send_json($resp) ;
        exit;
    }
}
add_action( 'wp_ajax_mypacco_config_db_call', 'mypacco_config_db_call' );

/*
    @purpose = This function is used to add new order
    @author = Rahul Sharma
    @type = External
*/
function add_order_form()
{
    global $wpdb;

    if(!empty($_POST))
    {
        $add_postdata_array['seller_order_number'] = $_POST['order_no'];
        $add_postdata_array['post_id'] = '0';
        $add_postdata_array['status'] = 1;
        $add_postdata_array['status_desc'] = 'Order Received';
        $add_postdata_array['delivery_fullname'] = $_POST['delivery_name'];
        $add_postdata_array['delivery_fullname'] = $_POST['mobile_no'];
        $add_postdata_array['delivery_fullname'] = $_POST['email_id'];
        $add_postdata_array['delivery_address'] = $_POST['address'];
        $add_postdata_array['delivery_city'] = $_POST['city'];
        $add_postdata_array['delivery_pincode'] = $_POST['pincode'];
        $add_postdata_array['delivery_state'] = $_POST['state'];
        $add_postdata_array['delivery_country'] = $_POST['country'];
        $add_postdata_array['currency_unit'] = 'INR';
        $add_postdata_array['seller_warehouse_code'] = $_POST['warehouse'];
        $add_postdata_array['transport_mode'] = $_POST['trans_mode'];
        $add_postdata_array['payment_type'] = $_POST['pay_mode'];
        $add_postdata_array['created_on'] = date('Y-m-d H:i:s');
        /* Create Item Detail array for add wp_mypacco_order_item_master Table */
        $add_postitemdata_array['currency_unit'] = 'INR';
        $add_postitemdata_array['weight'] = $_POST['weight'];
        $add_postitemdata_array['length'] = $_POST['length'];
        $add_postitemdata_array['width'] = $_POST['width'];
        $add_postitemdata_array['volumetric_weight'] = $_POST['val_weight'];
        $add_postitemdata_array['height'] = $_POST['height'];
        $add_postitemdata_array['base_price'] = $_POST['base_price'];
        $add_postitemdata_array['parcel_amount'] = $_POST['total_price'];
        $add_postitemdata_array['item_quantity'] = $_POST['item_quantity'];
        $add_postitemdata_array['item_title'] = $_POST['item_title'];

        $wpdb->insert('wp_mypacco_order_master', $add_postdata_array);
        $lastid = $wpdb->insert_id;
        /* Add Item Detail in wp_mypacco_order_item_master Table */
        $add_postitemdata_array['order_id'] = $lastid;
        $wpdb->insert('wp_mypacco_order_item_master', $add_postitemdata_array);

        if($lastid){
            $resp = array('html' => 'Order Added Successfully');
            wp_send_json($resp);
            exit;
        }

    }
}
add_action("wp_ajax_add_order_form", "add_order_form");
/*
    @purpose = This function is used to display manage order
    @author = Rahul Sharma
    @type = External
*/
function mypacco_manage_orders()
{
    global $wpdb;
    $order_status = (!empty($_POST['order_status'])) ? $_POST['order_status'] : '1';
    $html = '';

    /*Get data from db*/
    if($order_status == 1){
        $condition = 'status = 1 AND order_bouquet = 0 AND is_combined = 1';
    }else if($order_status ==5){
        $condition = 'status = 1 AND order_bouquet = 0 AND is_combined = 2 GROUP BY post_id';
    }else if($order_status ==2){
        $condition = 'order_bouquet = 1 GROUP BY mypacco_order_id';
    }else if($order_status ==3){
        $condition = 'order_bouquet = 2 GROUP BY mypacco_order_id';
    }else if($order_status ==4){
        $condition = 'order_bouquet = 3';
    }
    $table_name = $wpdb->prefix . "mypacco_order_master";
    $retrieve_data = $wpdb->get_results( "SELECT * FROM $table_name WHERE $condition" );

    //echo $wpdb->last_query; die();
    // Unship order Single
    if($order_status ==1){
        $html .= '<button onclick="readytoship();" style="float:right; margin-left:10px;" class="btn btn-success">RTS Selected Orders <i class="fa fa-mail-forward"></i></button>';
        $html .= '<button onclick="add_new_order();" style="float:right" class="btn btn-info">Fetch Woocommerce Order <i class=" fa fa-upload"></i></button>';
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped" id="order_tbl">';
        $html .= '<thead><tr><th><input type="checkbox" onclick="selectall(this);" id="select_all" name="select_all" /></th><th scope="col">Order No</th><th>Order Date</th><th>Item Title</th><th>Item Weight(Kg.)</th><th>Item Price</th><th scope="col">Delivery Detail</th><th scope="col"> Transport/Transaction <br>Mode</th><th scope="col">Pickup Detail</th><th scope="col">Action</th></tr></thead>';
        $html .= '<tbody id="the-list">';
        if(!empty($retrieve_data)){
        foreach($retrieve_data as $or_data)
        {
            /* Item Data */
            $itemcondition = 'post_id ='.$or_data->post_id;
            $itemtable_name = $wpdb->prefix . "mypacco_order_item_master";
            $retrieve_item_data = $wpdb->get_results( "SELECT * FROM $itemtable_name WHERE $itemcondition" );
            /* Transaction/Transport */
            if($or_data->transport_mode ==1){ $trans = 'Air';}else{$trans ='Surface';}
            if($or_data->payment_type ==1){ $pay = 'Prepaid';}else{$pay ='COD';}
            if($or_data->is_combined == 1 ){$is_combined='Single';}else{$is_combined='Combined';}
            $id = base64_encode($or_data->post_id);
            $encodedid = str_replace('=','',$id);
            $html .= '<tr>';
            $html .= '<th scope="row"><input type="checkbox" id="check_rts" name="check_rts" value="'.$or_data->order_id.'" /></th>';
            $html .= '<th scope="row">'.$or_data->seller_order_number.'</th>';
            $html .= '<th scope="row">'.date("d-m-Y H:i:s", strtotime($or_data->created_on)).'</th>';
            $html .= '<th scope="row">'.$retrieve_item_data[0]->item_title.'</th>';
            $html .= '<th scope="row">'.$retrieve_item_data[0]->weight.'</th>';
            $html .= '<th scope="row">'.$retrieve_item_data[0]->base_price.'</th>';
            $html .= '<th scope="row">'.$or_data->delivery_fullname.','.$or_data->delivery_address.'<br>'.$or_data->delivery_city.'-'.$or_data->delivery_state.'</th>';
            $html .= '<th scope="row">'.$trans.'/'.$pay.' </th>';
            $html .= '<th scope="row">'.$or_data->seller_warehouse_code.'</th>';
            $html .= '<th scope="row"><a class="btn btn-info btn-xs" href="'.admin_url('admin.php?page=mypacco_edit_order&id='.$encodedid).'"><i class="fa fa-pencil"></i></a>&nbsp;&nbsp;<butoon class="btn btn-primary btn-xs" onclick="viewOrder('.$or_data->order_id.')"><i class="fa fa-eye"></i></butoon></th>';
            $html .= '</tr>';
        }
        }else{ $html .= '<tr><th>No Data Found!!</th></tr>';}
    // Unship order Combine
    }else if($order_status ==5){
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped" id="order_tbl">';
        $html .= '<thead><tr><th></th><th scope="col">Order No</th><th>Order Date</th><th>Item Title</th><th scope="col">Delivery Detail</th><th scope="col"> Transport/Transaction <br>Mode</th><th scope="col">Pickup Detail</th><th scope="col">Action</th></tr></thead>';
        $html .= '<tbody id="the-list">';
        if(!empty($retrieve_data)){
        foreach($retrieve_data as $or_data)
        {
            /* Item Data */
            $itemcondition = 'post_id ='.$or_data->post_id;
            $itemtable_name = $wpdb->prefix . "mypacco_order_item_master";
            $retrieve_item_data = $wpdb->get_results( "SELECT * FROM $itemtable_name WHERE $itemcondition" );
            /* Transaction/Transport */
            if($or_data->transport_mode ==1){ $trans = 'Air';}else{$trans ='Surface';}
            if($or_data->payment_type ==1){ $pay = 'Prepaid';}else{$pay ='COD';}
            if($or_data->is_combined == 1 ){$is_combined='Single';}else{$is_combined='Combined';}
            $id = base64_encode($or_data->post_id);
            $encodedid = str_replace('=','',$id);
            $html .= '<tr>';
            $html .= '<th scope="row"><button id="check_rts" class="btn btn-success btn-xs" onclick="readytoshipcombined('.$or_data->post_id.')"><i class="fa fa-plus"></i></button></th>';
            $html .= '<th scope="row">'.$or_data->seller_order_number.'</th>';
            $html .= '<th scope="row">'.date("d-m-Y H:i:s", strtotime($or_data->created_on)).'</th>';
            $html .= '<th scope="row">'.$retrieve_item_data[0]->item_title.'</th>';
            $html .= '<th scope="row">'.$or_data->delivery_fullname.','.$or_data->delivery_address.'<br>'.$or_data->delivery_city.'-'.$or_data->delivery_state.'</th>';
            $html .= '<th scope="row">'.$trans.'/'.$pay.' </th>';
            $html .= '<th scope="row">'.$or_data->seller_warehouse_code.'</th>';
            $html .= '<th scope="row"><a class="btn btn-info btn-xs" href="'.admin_url('admin.php?page=mypacco_edit_order&id='.$encodedid).'"><i class="fa fa-pencil"></i></a>&nbsp;&nbsp;<butoon class="btn btn-primary btn-xs" onclick="viewOrder('.$or_data->order_id.')"><i class="fa fa-eye"></i></butoon></th>';
            $html .= '</tr>';
        }
        }else{ $html .= '<tr><th>No Data Found!!</th></tr>';}
    // Inprogress Order
    }else if($order_status ==2){
        //reaload_status();
        $html .= '<button onclick="realoadstatus(1,1);" style="float:right" class="btn btn-success">Refresh Status</button>';
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped" id="order_tbl">';
        $html .= '<thead><tr><th scope="col">Order No</th><th>RTS Date</th><th>Item Title</th><th scope="col">Delivery Detail</th><th scope="col">Pickup Detail</th><th scope="col">Status</th><th scope="col">Action</th></tr></thead>';
        $html .= '<tbody id="the-list">';
        if(!empty($retrieve_data)){
        foreach($retrieve_data as $or_data)
        {
            /* Item Data */
            $itemcondition = 'post_id ='.$or_data->order_id;
            $itemtable_name = $wpdb->prefix . "mypacco_order_item_master";
            $retrieve_item_data = $wpdb->get_results( "SELECT * FROM $itemtable_name WHERE $itemcondition" );
            /* Get Pick-up Detail */
            $ware_table_name = $wpdb->prefix . "mypacco_warehouse";
            $get_ware_data = $wpdb->get_results("SELECT * FROM $ware_table_name WHERE warehouse_code='".$or_data->seller_warehouse_code."'");
            $html .= '<tr>';
            $html .= '<th scope="row">'.$or_data->seller_order_number.'</th>';
            $html .= '<th scope="row">'.date("d-m-Y H:i:s", strtotime($or_data->rts_date)).'</th>';
            $html .= '<th scope="row">'.$retrieve_item_data[0]->item_title.'</th>';
            $html .= '<th scope="row">'.$or_data->delivery_fullname.','.$or_data->delivery_address.'<br>'.$or_data->delivery_city.'-'.$or_data->delivery_state.'</th>';
            //$html .= '<th scope="row">'.$or_data->supplier_name.'</th>';
            $html .= '<th scope="row">'.$get_ware_data[0]->warehouse_name.','.$get_ware_data[0]->address.'<br>'.$get_ware_data[0]->city.'-'.$get_ware_data[0]->state.'</th>';
            $html .= '<th scope="row">'.$or_data->status_desc.' </th>';
            $html .= '<th scope="row"><butoon class="btn btn-primary btn-xs" onclick="viewOrder('.$or_data->order_id.')"><i class="fa fa-eye"></i></butoon></th>';
            $html .= '</tr>';
        }
        }else{ $html .= '<tr><th>No Data Found!!</th></tr>';}
    // Processed Order
    }else if($order_status ==3){
        //reaload_status();
        $html .= '<button onclick="getdocuments();" style="margin-left:10px;" class="btn btn-success">All Documents <i class="fa fa-documents"></i></button>';
        $html .= '<button onclick="realoadstatus(2,2);" style="float:right" class="btn btn-success">Refresh Status</button>';
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped" id="order_tbl">';
        $html .= '<thead><tr><th><input type="checkbox" onclick="selectall(this);" id="select_all" name="select_all" /></th><th scope="col">Order No</th><th>Order Date</th><th>RTS Date</th><th scope="col">AWB Number</th><th scope="col">Delivery Detail</th><th scope="col">LSP Name</th><th scope="col">Pickup Detail</th><th scope="col">Transport/Transaction <br>Mode</th><th scope="col">Status</th><th scope="col">Action</th></tr></thead>';
        $html .= '<tbody id="the-list">';
        if(!empty($retrieve_data)){
        foreach($retrieve_data as $or_data)
        {
            /* Get Pick-up Detail */
            $ware_table_name = $wpdb->prefix . "mypacco_warehouse";
            $get_ware_data = $wpdb->get_results("SELECT * FROM $ware_table_name WHERE warehouse_code='".$or_data->seller_warehouse_code."'");
            /* Transaction/Transport Mode*/
            if($or_data->transport_mode ==1){$trans = 'Air';}else{$trans ='Surface';}
            if($or_data->payment_type ==1){$pay = 'Prepaid';}else{$pay ='COD';}

            $html .= '<tr>';
            if($or_data->status != 4 || $or_data->status != 5 || $or_data->status != 11){
                $html .= '<th scope="row"><input type="checkbox" id="check_rts" name="check_rts" value="'.$or_data->order_id.'" /></th>';
            }else{
                $html .= '<th scope="row"></th>';
            }
            $html .= '<th scope="row">'.$or_data->seller_order_number.'</th>';
            $html .= '<th scope="row">'.date("d-m-Y H:i:s", strtotime($or_data->created_on)).'</th>';
            $html .= '<th scope="row">'.date("d-m-Y H:i:s", strtotime($or_data->rts_date)).'</th>';
            $html .= '<th scope="row">'.$or_data->awb_number.'</th>';
            $html .= '<th scope="row">'.$or_data->delivery_fullname.','.$or_data->delivery_address.'<br>'.$or_data->delivery_city.'-'.$or_data->delivery_state.'</th>';
            $html .= '<th scope="row">'.$or_data->supplier_name.'</th>';
            $html .= '<th scope="row">'.$get_ware_data[0]->warehouse_name.','.$get_ware_data[0]->address.'<br>'.$get_ware_data[0]->city.'-'.$get_ware_data[0]->state.'</th>';
            $html .= '<th scope="row">'.$trans.'/'.$pay.' </th>';
            $html .= '<th scope="row">'.$or_data->status_desc.' </th>';
            $html .= '<th scope="row"><butoon class="btn btn-primary btn-xs" onclick="viewOrder('.$or_data->order_id.')"><i class="fa fa-eye"></i></butoon>';
            if($or_data->status == 2){
                $html .= '&nbsp;&nbsp;<button onclick="cancel_order('.$or_data->order_id.');" class="btn btn-danger btn-xs"> Cancel </button>';
            }
            $html .= '</th></tr>';
        }
        }else{ $html .= '<tr><th>No Data Found!!</th></tr>';}
    // Non serviceble Order
    }else{
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped" id="order_tbl">';
        $html .= '<thead><tr><th scope="col">Order No</th><th scope="col">Order Date</th><th scope="col">RTS Date</th><th scope="col">Delivery Detail</th><th scope="col">Warehouse Code</th><th scope="col">Pickup Detail</th><th scope="col">Action</th></tr></thead>';
        $html .= '<tbody id="the-list">';
        if(!empty($retrieve_data)){
        foreach($retrieve_data as $or_data)
        {
            $id = base64_encode($or_data->order_id);
            $encodedid = str_replace('=','',$id);
            /* Get Pick-up Detail */
            $ware_table_name = $wpdb->prefix . "mypacco_warehouse";
            $get_ware_data = $wpdb->get_results("SELECT * FROM $ware_table_name WHERE warehouse_code='".$or_data->seller_warehouse_code."'");
            $html .= '<tr>';
            $html .= '<th scope="row">'.$or_data->seller_order_number.'</th>';
            $html .= '<th scope="row">'.date("d-m-Y H:i:s", strtotime($or_data->created_on)).'</th>';
            $html .= '<th scope="row">'.date("d-m-Y H:i:s", strtotime($or_data->rts_date)).'</th>';
            $html .= '<th scope="row">'.$or_data->delivery_fullname.','.$or_data->delivery_address.'<br>'.$or_data->delivery_city.'-'.$or_data->delivery_state.'</th>';
            $html .= '<th scope="row">'.$or_data->seller_warehouse_code.'</th>';
            $html .= '<th scope="row">'.$get_ware_data[0]->warehouse_name.','.$get_ware_data[0]->address.'<br>'.$get_ware_data[0]->city.'-'.$get_ware_data[0]->state.'</th>';
            $html .= '<th scope="row"><a class="btn btn-info" href="'.admin_url('admin.php?page=mypacco_edit_order&id='.$encodedid).'"><i class="fa fa-pencil"></i></a>';
            if($or_data->status == 2){
                $html .= '&nbsp;&nbsp;<button onclick="cancel_order('.$or_data->order_id.');" class="btn btn-primary btn-xs"><i class="fa fa-close"></i></button>';
            }
            $html .= '</th>';
            $html .= '</tr>';
        }
        }else{ $html .= '<tr><th>No Data Found!!</th></tr>';}
    }
    $html .= '</table>';

    $resp = array('html' => $html);

    wp_send_json($resp);
    exit;
}
add_action("wp_ajax_mypacco_manage_orders", "mypacco_manage_orders");

/*
    @purpose = This function is used to add new order
    @author = Rahul Sharma
    @type = External
*/
function mypacco_add_new_order()
{
    global $wpdb;

    $html = '';
    $ids = '';
    /*Get inserted data from wp_mypacco_order_master*/
    $table_mypacco_order_master = $wpdb->prefix . "mypacco_order_master";
    $get_order_master = $wpdb->get_results( "SELECT * FROM $table_mypacco_order_master" );
    if(!empty($get_order_master)){
        $prifix = '';
        foreach($get_order_master AS $order_master){

            $ids .= $prefix . '' . $order_master->post_id ;
            $prefix = ',';
        }
    }else{
        $ids .= 0;
    }

    /*Get data from db*/
    $table_name = $wpdb->prefix . "posts";
    $get_post_data = $wpdb->get_results( "SELECT * FROM $table_name WHERE ID NOT IN ($ids) AND post_status = 'wc-processing' AND post_type = 'shop_order'" );

    if(!empty($get_post_data))
    {
        foreach($get_post_data as $post_data)
        {
            $item_table_name = $wpdb->prefix . "postmeta";
            $get_postmeta_data = $wpdb->get_results("SELECT * FROM $item_table_name WHERE post_id = ".$post_data->ID);

            /* Get Item count detail */
            $item_detail_table_name = $wpdb->prefix . "woocommerce_order_items";
            $get_item_data = $wpdb->get_results("SELECT * FROM $item_detail_table_name WHERE order_id = ".$post_data->ID." AND order_item_type = 'line_item'");
            /* Get order Shipping Charges */
            $get_Shipping_charge = $wpdb->get_results("SELECT * FROM $item_detail_table_name WHERE order_id = ".$post_data->ID." AND order_item_type = 'shipping'");
            /* Get Order Other Charges */
            $get_other_charge = $wpdb->get_results("SELECT * FROM $item_detail_table_name WHERE order_id = ".$post_data->ID." AND order_item_type = 'fee'");
            $itemcount = count($get_item_data);

            if($itemcount == '1'){$combine = 1;}else{$combine = 2;}
            $i=1;
            foreach($get_item_data AS $item)
            {
                foreach($get_postmeta_data AS $postData)
                {
                    $add_postdata_array['seller_order_number'] = (isset($post_data->post_name))?substr_replace($post_data->post_name, "", -3).''.$i:'';
                    $add_postdata_array['post_id'] = $post_data->ID;
                    $add_postdata_array['order_bouquet'] = 0;
                    $add_postdata_array['is_combined'] = $combine;
                    $add_postdata_array['transport_mode'] = 1;
                    $add_postdata_array['status'] = 1;
                    $add_postdata_array['status_desc'] = 'Order Received';
                    if($postData->meta_key == '_shipping_first_name' && !empty($postData->meta_value)){$add_postdata_array['delivery_fullname'] = $postData->meta_value;}else if($postData->meta_key == '_billing_first_name'){$add_postdata_array['delivery_fullname'] = $postData->meta_value;}
                    if($postData->meta_key == '_shipping_address_1' && !empty($postData->meta_value)){$add_postdata_array['delivery_address'] = $postData->meta_value;}else if($postData->meta_key == '_billing_address_1'){$add_postdata_array['delivery_address'] = $postData->meta_value;}
                    if($postData->meta_key == '_shipping_city' && !empty($postData->meta_value)){$add_postdata_array['delivery_city'] = $postData->meta_value;}else if($postData->meta_key == '_billing_city'){$add_postdata_array['delivery_city'] = $postData->meta_value;}
                    if($postData->meta_key == '_shipping_postcode' && !empty($postData->meta_value)){$add_postdata_array['delivery_pincode'] = $postData->meta_value;}else if($postData->meta_key == '_billing_postcode'){$add_postdata_array['delivery_pincode'] = $postData->meta_value;}
                    if($postData->meta_key == '_shipping_state' && !empty($postData->meta_value)){$add_postdata_array['delivery_state'] = $postData->meta_value;}else if($postData->meta_key == '_billing_state'){$add_postdata_array['delivery_state'] = $postData->meta_value;}
                    /* Mobile & Email Detail From Billing Detail  */
                    if($postData->meta_key == '_billing_email' && !empty($postData->meta_value)){$add_postdata_array['delivery_email'] = $postData->meta_value;}
                    if($postData->meta_key == '_billing_phone' && !empty($postData->meta_value)){$add_postdata_array['delivery_mobile'] = $postData->meta_value;}
                    /* End Code */
                    if($postData->meta_key == '_shipping_country' && !empty($postData->meta_value)){$add_postdata_array['delivery_country'] = $postData->meta_value;}else if($postData->meta_key == '_billing_country'){$add_postdata_array['delivery_country'] = $postData->meta_value;}
                    if($postData->meta_key == '_order_currency' && !empty($postData->meta_value)){$add_postdata_array['currency_unit'] = $postData->meta_value;}else if($postData->meta_key == '_order_currency'){$add_postdata_array['currency_unit'] = $postData->meta_value;}
                    if($postData->meta_key == '_payment_method' && !empty($postData->meta_value)){ $payment_method = ($postData->meta_value == 'cod')?'2':'1';}
                    $add_postdata_array['created_on'] = date('Y-m-d H:i:s');
                    /* Create Item Detail array for add wp_mypacco_order_item_master Table */

                    if($postData->meta_key == '_order_currency'){$add_postitemdata_array['currency_unit'] = $postData->meta_value;}

                }
                // $add_postdata_array['payment_type']
                if(!empty($payment_method)){$add_postdata_array['payment_type']=$payment_method;}else{$add_postdata_array['payment_type'] = 1;}
                $wpdb->insert('wp_mypacco_order_master', $add_postdata_array);
                $lastid = $wpdb->insert_id;

                /* Unset email and mobile data from billing detail */
                unset($add_postdata_array['delivery_email']);
                unset($add_postdata_array['delivery_mobile']);
                /* Insert Order Item Detail in wp_mypacco_order_item_master  */
                $add_postitemdata_array['item_title'] = $item->order_item_name;
                $add_postitemdata_array['post_id'] = $post_data->ID;
                $itemmeta_detail_table_name = $wpdb->prefix . "woocommerce_order_itemmeta";
                /* get Order Item Height, Width, Length  */
                $get_itemLBH_ID = $wpdb->get_results("SELECT * FROM $itemmeta_detail_table_name WHERE order_item_id = ".$item->order_item_id." AND meta_key = '_product_id'");
                $get_itemLBH_Data = $wpdb->get_results("SELECT * FROM $item_table_name WHERE post_id = ".$get_itemLBH_ID[0]->meta_value);

                foreach($get_itemLBH_Data AS $lbh){
                    if($lbh->meta_key == '_weight'){$weight = $lbh->meta_value;}
                    if($lbh->meta_key == '_length'){$length = $lbh->meta_value;}
                    if($lbh->meta_key == '_width'){$width = $lbh->meta_value;}
                    if($lbh->meta_key == '_height'){$height = $lbh->meta_value;}
                }
                if(!empty($weight)){$add_postitemdata_array['weight']=$weight;}else{$add_postitemdata_array['weight'] = 0.5;}
                if(!empty($length)){$add_postitemdata_array['length']=$length;}else{$add_postitemdata_array['length'] = 13;}
                if(!empty($width)){$add_postitemdata_array['width']=$width;}else{$add_postitemdata_array['width'] = 13;}
                if(!empty($height)){$add_postitemdata_array['height']=$height;}else{$add_postitemdata_array['height'] = 13;}

                /* Get Shipping Price from woocommerce_order_itemmeta */

                if(count($get_Shipping_charge) > 0){

                    $get_shipping_data = $wpdb->get_results("SELECT * FROM $itemmeta_detail_table_name WHERE order_item_id = ".$get_Shipping_charge[0]->order_item_id." AND meta_key = 'cost'");

                }

                if(count($get_shipping_data) > 0){$shipping = $get_shipping_data[0]->meta_value;}else{ $shipping = '0.00';}
                if($shipping != 0){
                    $shippingcost = $shipping / $itemcount;
                }else{
                    $shippingcost = $shipping;
                }

                $add_postitemdata_array['shipp_handling_charges'] = $shippingcost;
                unset($get_shipping_data);
                /* Get Other Charges from woocommerce_order_itemmeta */
                if(!empty($get_other_charge)){
                    $get_other_charge_data = $wpdb->get_results("SELECT * FROM $itemmeta_detail_table_name WHERE order_item_id = ".$get_other_charge[0]->order_item_id." AND meta_key = '_line_total'");
                }
                if(!empty($get_other_charge_data)){$other_charges = $get_other_charge_data[0]->meta_value;}else{ $other_charges = '0.00';}
                if($other_charges != 0){
                    $othercost = $other_charges / $itemcount;
                }else{
                    $othercost = $other_charges;
                }
                $add_postitemdata_array['other_charges'] = $othercost;
                unset($get_shipping_data);
                /* Get Item detail */
                $get_itemmeta_data = $wpdb->get_results("SELECT * FROM $itemmeta_detail_table_name WHERE order_item_id = ".$item->order_item_id);
                foreach($get_itemmeta_data AS $itemmeta_data){

                    /* Add Item Detail in wp_mypacco_order_item_master Table */
                    if($itemmeta_data->meta_key == '_qty' && $item->order_item_id == $itemmeta_data->order_item_id){$add_postitemdata_array['item_quantity'] = $itemmeta_data->meta_value;}
                    if($itemmeta_data->meta_key == '_line_total' && $item->order_item_id == $itemmeta_data->order_item_id){$add_postitemdata_array['base_price'] = $itemmeta_data->meta_value;}

                }
                $add_postitemdata_array['parcel_amount'] = $add_postitemdata_array['base_price'] + $shippingcost + $othercost;
                $add_postitemdata_array['order_id'] = $lastid;

                $wpdb->insert('wp_mypacco_order_item_master', $add_postitemdata_array);

                $i++;
            }

        }
        $resp = array('html' => 'Order Added Successfully !!');
    }else{
        $resp = array('html' => 'No new order found ??');
    }

    wp_send_json($resp);
    exit;
}
add_action("wp_ajax_mypacco_add_new_order", "mypacco_add_new_order");

/* @purpose Checked order For RTS Single Orders*/
/* @Rahul Sharma */
/* Type: External */
    function Rts_Orders()
    {
        global $wpdb;
        if($_POST['order_ids'] == '' || $_POST['order_ids'] == NULL){
            $resp = array('html' => 'Please Select Order !!');
            wp_send_json($resp);
            exit;
        }
        $ids = str_replace("on-","",$_POST['order_ids']);

        $final_order_ids = trim($ids, "-");

        $final_ids = str_replace("-",",",$final_order_ids);

        $final_orderid = array();
        if (strpos($final_ids,',') !== false) {
            $final_orderid = explode(",",$final_ids);
        }else{
            $final_orderid[] = $final_ids;
        }

        /* Get warehouse List */
        $table_name = $wpdb->prefix . "mypacco_warehouse";
        $get_ware_data = $wpdb->get_results("SELECT * FROM $table_name");

        $html = '';

        $html .= '<form name="order_rts" onsubmit="return makeRTS()" id="order_rts">';
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped" id="order_rts_tbl">';
        $html .= '<thead><tr><th scope="col">Select Warehouse</th><th scope="col">Height</th><th scope="col">Width</th><th scope="col">Length</th><th scope="col">Weight</th></tr></thead>';

        $html .= '<tbody id="the-list">';
        $i= 1;
        foreach($final_orderid as $or_data)
        {
            /* Get Order Data */
            $order_table_name = $wpdb->prefix . "mypacco_order_master";
            $get_order_data = $wpdb->get_results("SELECT * FROM $order_table_name WHERE order_id =".$or_data);
            /* Get Order Item Data */
            $item_table_name = $wpdb->prefix . "mypacco_order_item_master";
            $get_item_data = $wpdb->get_results("SELECT * FROM $item_table_name WHERE order_id =".$or_data);

            foreach($get_item_data AS $itemData){
                $html .= '<tr>';
                $html .= '<input type="hidden" name="order_id[]" value="'.$or_data.'">';
                $html .= '<input type="hidden" name="orderitem_id[]" value="'.$itemData->order_item_id.'">';
                $html .= '<th scope="row"><select style="width:100%;" class="validate[required]" name="warehouse_name[]" id="warehouse_name_'.$i.'">
                    <option value="">--Select--</option>';
                    if(!empty($get_ware_data)){
                    foreach($get_ware_data as $warehouse){
                        if($warehouse->warehouse_code == $get_order_data[0]->seller_warehouse_code){
                            $select = 'selected';
                        }else{$select = '';}
                        $html .= '<option '.$select.' value="'.$warehouse->warehouse_code.'">'.$warehouse->warehouse_name.'('.$warehouse->warehouse_code.')</option>';
                    }	}
                $html .= '</select></th>';
                $html .= '<th scope="row"><input class="validate[required,custom[number]]" value="'.$itemData->height.'" style="width:95%;" type="text" name="height[]" id="height_'.$i.'" /></th>';
                $html .= '<th scope="row"><input class="validate[required,custom[number]]" value="'.$itemData->width.'" style="width:95%;" type="text" name="width[]" id="width_'.$i.'" /></th>';
                $html .= '<th scope="row"><input class="validate[required,custom[number]]" value="'.$itemData->length.'" style="width:95%;" type="text" name="length[]" id="length_'.$i.'" /></th>';
                $html .= '<th scope="row"><input class="validate[required,custom[number]]" value="'.$itemData->weight.'"  style="width:95%;" type="text" name="weight[]" id="weight_'.$i.'" /></th>';

                $html .= '</tr>';
            }

            $i++;
        }
        $html .= '<tr><td></td><td></td><td></td><td></td><td><input type="submit" class="btn btn-primary pull-right" value="submit"></td></tr>';
        $html .='</table>';
        $html .= '</form>';

        $resp = array('html' => $html);
        wp_send_json($resp);
        exit;

   }
add_action("wp_ajax_Rts_Orders", "Rts_Orders");

/* @purpose update order data and mark as RTS (Single Orders) */
/* @Rahul Sharma */
/* Type: Internal */
    function submit_rts_Orders()
    {
        global $api_url, $wpdb;

        $count = count($_POST['height']);

        for($i=0; $i<$count; $i++){
            $orderitem_id = $_POST['orderitem_id'][$i];
            $order_id = $_POST['order_id'][$i];
            $height = $_POST['height'][$i];
            $width = $_POST['width'][$i];
            $length = $_POST['length'][$i];
            $weight = $_POST['weight'][$i];
            $warehousename = $_POST['warehouse_name'][$i];

            $val_weight = ($height * $width * $length)/5000;

            $update_item = array('height' => $height,'width' => $width,'length' => $length,'weight' => $weight,'volumetric_weight' => $val_weight);

            $update = array('seller_warehouse_code' => $warehousename,
                            'rts_date' => date('Y-m-d H:i:s'));
            /* Update Query */
            $wpdb->update('wp_mypacco_order_item_master', $update_item, array('order_id' => $order_id, 'order_item_id' =>$orderitem_id));
            $wpdb->update('wp_mypacco_order_master', $update, array('order_id' => $order_id));
            //Check client_id, client_secret is correct
            $access_token = getAccessToken();
            $access = json_decode($access_token, true);

            if($access['error'] == 1){
                $resp = array('html' => "Error1 : <strong>".$access['msg']."</strong>");
                wp_send_json($resp) ;
                exit;
            }
            /* Add order in order master table */
            $addOrder = add_order($order_id);

            $trackResponse = json_decode($addOrder, true);

            /* Get Mypacco ID */
            if($trackResponse['IsSuccess'] == 1){
                /*$mypacco_order_id = $trackResponse['Response']['order'][0]['order_detail'][0]['mypacco_order_no']; Sandbox */
                $mypacco_order_id = $trackResponse['Data'][0]['mypacco_order_id'];
                $updatedetail = array('mypacco_order_id' => $mypacco_order_id,
                                    'status' => 2,
                                    'order_bouquet' => 1,
                                    'status_desc' => "Ready To Ship");
                $wpdb->update('wp_mypacco_order_master', $updatedetail, array('order_id' => $order_id));
                $wpdb->update('wp_mypacco_order_item_master', array('mypacco_order_id' => $mypacco_order_id), array('order_id' => $order_id));
                $resp = array('html' => "Order has been RTS successfully.");

            }else{
                $resp = array('html' => "Error : ".$trackResponse['Data'][0]['error_message']."");
                $wpdb->update('wp_mypacco_order_master', array('status' => 1, 'order_bouquet'=>0), array('order_id' => $order_id));
            }

        }
       wp_send_json($resp);
       exit;
    }
add_action("wp_ajax_submit_rts_Orders", "submit_rts_Orders");

/* @purpose Add Order with curl Single Order */
/* @Rahul Sharma */
/* Type: Internal */
    function add_order($order_id)
    {
        global $api_url, $wpdb;
        /*generate pickup date for lsp*/
        $PICKUP_CUTOFF = '13:00:00';
        $cut_off_time = date("Y-m-d H:i:s", strtotime($PICKUP_CUTOFF));

        $current_date_time = date("Y-m-d H:i:s");

        $pickup_generated_for_date = '';

        if($current_date_time < $cut_off_time)
        {
            $pickup_generated_for_date = date("Y-m-d");;
        }
        else
        {
            $pickup_generated_for_date = date('Y-m-d',strtotime($current_date_time . "+1 days"));
        }

        $itemtable_name = $wpdb->prefix . "mypacco_order_item_master";
        $get_item_data = $wpdb->get_results("SELECT * FROM $itemtable_name WHERE order_id = ".$order_id);

        $table_name = $wpdb->prefix . "mypacco_order_master";
        $get_order_data = $wpdb->get_results("SELECT * FROM $table_name WHERE order_id = ".$order_id);

        $add_order = '';
        $add_order["seller_order_number"]= $get_order_data[0]->seller_order_number;
        $add_order["seller_warehouse_code"]= $get_order_data[0]->seller_warehouse_code;
        $add_order["delivery_fullname"]= $get_order_data[0]->delivery_fullname;
        $add_order["delivery_mobile"]= (!empty($get_order_data[0]->delivery_mobile)?$get_order_data[0]->delivery_mobile:'9899999999');
        $add_order["delivery_email"]= $get_order_data[0]->delivery_email;
        $add_order["delivery_address"]= $get_order_data[0]->delivery_address;
        $add_order["delivery_pincode"]= $get_order_data[0]->delivery_pincode;
        $add_order["delivery_landmark"]= "-";
        $add_order["delivery_city"]= $get_order_data[0]->delivery_city;
        $add_order["delivery_state"]= $get_order_data[0]->delivery_state;
        $add_order["delivery_country"]= $get_order_data[0]->delivery_country;
        $add_order["transport_mode"]= $get_order_data[0]->transport_mode;
        $add_order["payment_type"]= $get_order_data[0]->payment_type;
        $add_order["order_source"]= 'wordpress';

        $add_order["item_title"]= $get_item_data[0]->item_title;
        $add_order["item_desc"]= $get_item_data[0]->parcel_desc;
        $add_order["item_quantity"]= $get_item_data[0]->item_quantity;
        $add_order["length"]= $get_item_data[0]->length;
        $add_order["height"]= $get_item_data[0]->height;
        $add_order["width"]= $get_item_data[0]->width;
        $add_order["weight"]= $get_item_data[0]->weight;
        $add_order["base_price"]= $get_item_data[0]->base_price;
        $add_order["shipp_handling_charges"]= $get_item_data[0]->shipp_handling_charges;
        $add_order["other_charges"]= $get_item_data[0]->other_charges;
        $add_order["total_amount"]= $get_item_data[0]->parcel_amount;

        $add_order["currency_unit"]= $get_item_data[0]->currency_unit;
        $add_order["pickup_date"]= $pickup_generated_for_date;

        $returnresponse = getAccessToken();

        $access = json_decode($returnresponse, true);

        /* Call API Add Order method to add order */
        $send_array['access_token'] = $access['access_token'];
        $order_data['rts_order']= true;

        $order_data['orders']= array($add_order);
        $send_array['data'] = array($order_data);
        $sendarray = json_encode($send_array, JSON_PRETTY_PRINT);

        $push_url = $api_url.'addOrder';

        $response = curl_req($push_url, $sendarray);

        return $response;
    }


/* @purpose Checked Combined order items For RTS */
/* @Rahul Sharma */
/* Type: External */
    function Rts_combine_Orders()
    {
        global $wpdb;
        if($_POST['order_ids'] == '' || $_POST['order_ids'] == NULL){
            $resp = array('html' => 'Please Select Order !!');
            wp_send_json($resp);
            exit;
        }

        $post_ids = $_POST['order_ids'];

        /* Get Combine order data List */
        $ordertable_name = $wpdb->prefix . "mypacco_order_master";
        $get_order_data = $wpdb->get_results("SELECT * FROM $ordertable_name WHERE post_id =".$post_ids." AND status = 1");

        /* Get warehouse List */
        $table_name = $wpdb->prefix . "mypacco_warehouse";
        $get_ware_data = $wpdb->get_results("SELECT * FROM $table_name");

        $html = '';

        $html .= '<form name="combine_order_rts" onsubmit="return makeCombineRTS()" id="combine_order_rts">';
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped" id="order_rts_tbl">';
        $html .= '<thead><tr><th></th><th scope="col">Height</th><th scope="col">Width</th><th scope="col">Length</th><th scope="col">Weight</th></tr></thead>';

        $html .= '<tbody id="the-list">';
        $i= 0;
        foreach($get_order_data as $or_data)
        {
            $item_table_name = $wpdb->prefix . "mypacco_order_item_master";
            $get_item_data = $wpdb->get_results("SELECT * FROM $item_table_name WHERE order_id =".$or_data->order_id);

            $html .= '<tr>';
            $html .= '<input type="hidden" id="order_id_'.$i.'" name="order_id['.$i.']" value="'.$or_data->order_id.'">';
            $html .= '<input type="hidden" name="orderitem_id['.$i.']" value="'.$get_item_data[0]->order_item_id.'">';
            $html .= '<th scope="row"><input type="checkbox" onclick="com_item('.$i.')" name="check_item['.$i.']" id="check_item_'.$i.'" value="'.$or_data->order_id.'">&nbsp;&nbsp;'.$get_item_data[0]->item_title.'</th>';
            $html .= '<th scope="row"><input readonly  class="validate[required,custom[number]]" value="'.$get_item_data[0]->height.'" style="width:95%;" type="text" name="height['.$i.']" id="height_'.$i.'" /></th>';
            $html .= '<th scope="row"><input readonly  class="validate[required,custom[number]]" value="'.$get_item_data[0]->width.'" style="width:95%;" type="text" name="width['.$i.']" id="width_'.$i.'" /></th>';
            $html .= '<th scope="row"><input readonly  class="validate[required,custom[number]]" value="'.$get_item_data[0]->length.'" style="width:95%;" type="text" name="length['.$i.']" id="length_'.$i.'" /></th>';
            $html .= '<th scope="row"><input readonly  class="validate[required,custom[number]]" value="'.$get_item_data[0]->weight.'"  style="width:95%;" type="text" name="weight['.$i.']" id="weight_'.$i.'" /></th>';

            $html .= '</tr>';
            $i++;
        }
        $html .= '</table><table><tr><td><div style="width:865px;" class="panel-heading">Combined Order Detail<span class="tools pull-right"></div></td></tr></table>';
        $html .= '<table class="wp-list-table widefat fixed striped posts display table table-bordered table-striped"><tr><td><b>Weight</b>&nbsp;<input type="text" readonly value="0" name="com_weight" id="com_weight" /></td><td><b>Height</b>&nbsp;<input class="validate[required,custom[number]]" type="text" onkeyup="val_weight()" value="0" name="com_height" readonly id="com_height" /></td>
        <td><b>Width</b>&nbsp;<input class="validate[required,custom[number]]" onkeyup="val_weight()" value="0" type="text" name="com_width" readonly id="com_width" /></td>
        <td><b>Length</b>&nbsp;<input class="validate[required,custom[number]]" onkeyup="val_weight()" value="0" type="text" name="com_length" readonly id="com_length" /></td><td><b>Val. Weight</b>&nbsp;<input readonly class="validate[required,custom[number]]" type="text" value="0" name="com_valuemetric" id="com_valuemetric" /></td></tr>';

        $html .= '<tr><td><strong>Warehouse</strong>&nbsp;<select style="width:153px;" class="validate[required]" name="warehouse_name" id="warehouse_name">
                <option value="">--Select--</option>';
                if(!empty($get_ware_data)){
                foreach($get_ware_data as $warehouse){
                    if($warehouse->warehouse_code == $get_order_data[0]->seller_warehouse_code){
                        $select = 'selected';
                    }else{$select = '';}
                    $html .= '<option '.$select.' value="'.$warehouse->warehouse_code.'">'.$warehouse->warehouse_name.'('.$warehouse->warehouse_code.')</option>';
                }	}
        $html .= '</select></td>
        </tr>';
        $html .= '<tr style="margin:10px;"><td></td><td></td><td></td><td></td><td><button  style="margin:10px;" type="button" onclick="makeCombineRTS()" class="btn btn-primary pull-right"> Submit</button></td></tr>';
        $html .='</table>';
        $html .= '</form>';

        $resp = array('html' => $html);
        wp_send_json($resp);
        exit;

   }
add_action("wp_ajax_Rts_combine_Orders", "Rts_combine_Orders");


/* @purpose update order data and mark as RTS */
/* @Rahul Sharma */
/* Type: Internal */
    function submit_combine_rts_Orders()
    {
        global $api_url, $wpdb;

        $count = count($_POST['check_item']);

        for($i=0; $i < $count; $i++){

            foreach($_POST['check_item'] as $key => $valuekey){

                $order_id = $_POST['order_id'][$key];
                $orderitem_id = $_POST['orderitem_id'][$key];
                $warehouse_name = $_POST['warehouse_name'];
                $height = $_POST['height'][$key];
                $width = $_POST['width'][$key];
                $length = $_POST['length'][$key];
                $weight = $_POST['weight'][$key];


                $val_weight = ($height * $width * $length)/5000;

                $update_item = array('height' => $height,'width' => $width,'length' => $length,'weight' => $weight,'volumetric_weight' => $val_weight);

                $update = array('seller_warehouse_code' => $warehouse_name,
                                'rts_date' => date('Y-m-d H:i:s')
                                );
                /* Update Query */
                $wpdb->update('wp_mypacco_order_item_master', $update_item, array('order_id' => $order_id, 'order_item_id' =>$orderitem_id));
                $wpdb->update('wp_mypacco_order_master', $update, array('order_id' => $order_id));
            }

        }
        $orderid = $_POST['check_item'];

        $array['com_height'] = $_POST['com_height'];
        $array['com_width'] = $_POST['com_width'];
        $array['com_length'] = $_POST['com_length'];
        $array['com_weight'] = $_POST['com_weight'];
        $array['orderid'] = $orderid;

        //Check client_id, client_secret is correct
        $access_token = getAccessToken();
        $access = json_decode($access_token, true);

        if($access['error'] == 1){
            $resp = array('html' => "Error : <strong>".$access['msg']."</strong>");
            wp_send_json($resp) ;
            exit;
        }
        /* Add order in order master table */
        $addOrder = add_combine_order($array);

        $trackResponse = json_decode($addOrder, true);

        /* Get Mypacco ID */
        if($trackResponse['IsSuccess'] == 1){
            /* $mypacco_order_id = $trackResponse['Response']['order'][0]['order_detail'][0]['mypacco_order_no']; */
            $mypacco_order_id = $trackResponse['Data'][0]['mypacco_order_id'];
            foreach($orderid AS $order){
                $updatedetail = array('mypacco_order_id' => $mypacco_order_id,
                                'status' => 2,
                                'order_bouquet' => 1,
                                'status_desc' => "Ready To Ship");
                $wpdb->update('wp_mypacco_order_master', $updatedetail, array('order_id' => $order));
                $wpdb->update('wp_mypacco_order_item_master', array('mypacco_order_id' => $mypacco_order_id), array('order_id' => $order));
            }
            $resp = array('html' => "Order has been RTS successfully.");

        }else{
            $resp = array('html' => "Error : ".$trackResponse['Data'][0]['error_message']."");
            $wpdb->update('wp_mypacco_order_master', array('status' => 1, 'order_bouquet'=>0), array('order_id' => $order_id));
        }

        wp_send_json($resp);
       exit;
    }
add_action("wp_ajax_submit_combine_rts_Orders", "submit_combine_rts_Orders");

    /* @purpose Add Order with curl Combined Order */
    /* @Rahul Sharma */
    /* Type: Internal */
    function add_combine_order($array)
    {

        global $api_url, $wpdb;

        $com_height = $array['com_height'];
        $com_width = $array['com_width'];
        $com_length = $array['com_length'];
        $com_weight = $array['com_weight'];
        $order_id = $array['orderid'];

        $firstorderID = reset($order_id);
        /*generate pickup date for lsp*/
        $PICKUP_CUTOFF = '13:00:00';
        $cut_off_time = date("Y-m-d H:i:s", strtotime($PICKUP_CUTOFF));

        $current_date_time = date("Y-m-d H:i:s");

        $pickup_generated_for_date = '';

        if($current_date_time < $cut_off_time)
        {
            $pickup_generated_for_date = date("Y-m-d");
        }
        else
        {
            $pickup_generated_for_date = date('Y-m-d',strtotime($current_date_time . "+1 days"));
        }
        /* Get Order Detail Basic (Order Master Table)  */
        $table_name = $wpdb->prefix . "mypacco_order_master";
        $get_order_data = $wpdb->get_results("SELECT * FROM $table_name WHERE order_id = ".$firstorderID);

        $addorderitem = array();
        foreach($order_id AS $orderID){
            /* Get Combined Item details */
            $itemtable_name = $wpdb->prefix . "mypacco_order_item_master";
            $get_item_data = $wpdb->get_results("SELECT * FROM $itemtable_name WHERE order_id = ".$orderID);

            $add_order_item["item_title"]= $get_item_data[0]->item_title;
            $add_order_item["item_desc"]= $get_item_data[0]->parcel_desc;
            $add_order_item["item_quantity"]= $get_item_data[0]->item_quantity;
            $add_order_item["length"]= $get_item_data[0]->length;
            $add_order_item["height"]= $get_item_data[0]->height;
            $add_order_item["width"]= $get_item_data[0]->width;
            $add_order_item["weight"]= $get_item_data[0]->weight;
            $add_order_item["base_price"]= $get_item_data[0]->base_price;
            $add_order_item["shipp_handling_charges"]= $get_item_data[0]->shipp_handling_charges;
            $add_order_item["other_charges"]= $get_item_data[0]->other_charges;
            $add_order_item["total_amount"]= $get_item_data[0]->parcel_amount;
            /* Marge item details array */
            $addorderitem[] = $add_order_item;
            /* Add Combine item value */
            $com_order_base_price += $get_item_data[0]->base_price;
            $com_order_shipp_handling_charges += $get_item_data[0]->shipp_handling_charges;
            $com_order_other_charges += $get_item_data[0]->other_charges;
            $com_order_parcel_amount += $get_item_data[0]->parcel_amount;

        }

        /* Combine Order Item Detail Array */

        $combined_base_price = "'".$com_order_base_price."'";
        $combined_shipp_handling_charges = "'".$com_order_shipp_handling_charges."'";
        $combined_other_charges = "'".$com_order_other_charges."'";
        $combined_total_amount = "'".$com_order_parcel_amount."'";

        $combine["combined_length"] = $com_length;
        $combine["combined_height"] = $com_height;
        $combine["combined_width"] = $com_width;
        $combine["combined_weight"] = $com_weight;
        $combine["combined_base_price"] = str_replace("'","",$combined_base_price);
        $combine["combined_shipp_handling_charges"] = str_replace("'","",$combined_shipp_handling_charges);
        $combine["combined_other_charges"] = str_replace("'","",$combined_other_charges);
        $combine["combined_total_amount"] = str_replace("'","",$combined_total_amount);
        /* Add order array */
        $add_order = '';
        $add_order["seller_order_number"]= $get_order_data[0]->seller_order_number;
        $add_order["seller_warehouse_code"]= $get_order_data[0]->seller_warehouse_code;
        $add_order["delivery_fullname"]= $get_order_data[0]->delivery_fullname;
        $add_order["delivery_mobile"]= (!empty($get_order_data[0]->delivery_mobile)?$get_order_data[0]->delivery_mobile:'9899999999');
        $add_order["delivery_email"]= $get_order_data[0]->delivery_email;
        $add_order["delivery_address"]= $get_order_data[0]->delivery_address;
        $add_order["delivery_pincode"]= $get_order_data[0]->delivery_pincode;
        $add_order["delivery_landmark"]= "-";
        $add_order["delivery_city"]= $get_order_data[0]->delivery_city;
        $add_order["delivery_state"]= $get_order_data[0]->delivery_state;
        $add_order["delivery_country"]= $get_order_data[0]->delivery_country;
        $add_order["transport_mode"]= $get_order_data[0]->transport_mode;
        $add_order["payment_type"]= $get_order_data[0]->payment_type;
        $add_order["currency_unit"]= $get_order_data[0]->currency_unit;
        $add_order["pickup_date"]= $pickup_generated_for_date;
        $add_order["order_source"]= 'wordpress';
        $add_order["combined_order"]= TRUE;
        $add_order["order_items"]= $addorderitem;
        $add_order["combined_order_values"]= array($combine);

        $returnresponse = getAccessToken();
        $access = json_decode($returnresponse, true);

        /* Call API Add Order method to add order */
        $send_array['access_token'] = $access['access_token'];

        $order_data['rts_order']= true;

        $order_data['orders']= array($add_order);
        $send_array['data'] = array($order_data);
        $sendarray = json_encode($send_array, JSON_PRETTY_PRINT);

        $push_url = $api_url.'addOrder';

        $response = curl_req($push_url, $sendarray);

        return $response;
    }

    /* @purpose Refresh Status  */
    /* @Rahul Sharma */
    /* Type: External */
    function reaload_status(){
        global $api_url, $wpdb;

        $return_awb = getAwbNo(1);

        $table_name = $wpdb->prefix . "mypacco_order_master";
        $get_order_data = $wpdb->get_results("SELECT mypacco_order_id FROM $table_name WHERE status != 4 AND status != 1 AND status != 7 AND mypacco_order_id != ''");

        /* Get track */
        $MPID = array();

        foreach ($get_order_data as $order_data)
        {
            $MPID[] = $order_data->mypacco_order_id;
        }

        /* Call API Add Order method to add order */
        if($MPID != ''){

            $returnresponse = getAccessToken();
            $access = json_decode($returnresponse, true);


            $send_array['access_token'] = $access['access_token'];
            $send_array['data'][0]['tracking_number'] = $MPID;


            $sendarray = json_encode($send_array, JSON_PRETTY_PRINT);

            $push_url = $api_url.'trackOrder';

            $response = curl_req($push_url, $sendarray);

            $trackResponse = json_decode($response, true);

            if($trackResponse['IsSuccess'] == 1)
            {
                foreach($trackResponse['Data'] AS $returnresponse){

                    $AWBNumber = $returnresponse['AWBNumber'];
                    $mpID = $returnresponse['MyPaccoId'];
                    $TrackingStatus = $returnresponse['TrackingStatus'];
                    $lateststatus = end($TrackingStatus);

                    /* Get Order Detail Basic (Order Master Table)  */
                    $table = $wpdb->prefix . "mypacco_order_master";
                    $get_order_data = $wpdb->get_results("SELECT * FROM $table WHERE mypacco_order_id = ".$mpID);
                    foreach($get_order_data AS $odata){
                        /* Update order status */
                        $update = array('supplier_name'=>$lateststatus['supplier_name'],'status'=>$lateststatus['status_id'],'awb_number'=>$AWBNumber,'order_bouquet'=>2,'status_desc'=>$lateststatus['status'],'last_status_changed_date'=>$lateststatus['date']);
                        $wpdb->update('wp_mypacco_order_master', $update, array('order_id' => $odata->order_id));

                    }
                }
            }

        }
        exit;

    }
add_action("wp_ajax_reaload_status", "reaload_status");
    /* @purpose Get Order AWB Number */
    /* @Rahul Sharma */
    /* Type: Internal */
    function getAwbNo($status)
    {
        global $api_url, $wpdb;

        $table_name = $wpdb->prefix . "mypacco_order_master";
        $get_order_data = $wpdb->get_results("SELECT mypacco_order_id FROM $table_name WHERE order_bouquet = ".$status." AND mypacco_order_id != '' AND status != 7");

        /* Get AWB */
        $MPID = array();

        foreach ($get_order_data as $order_data)
        {
            $MPID[] = $order_data->mypacco_order_id;
        }

        /* Call API Add Order method to add order */
        if($MPID != ''){

            $returnresponse = getAccessToken();
            $access = json_decode($returnresponse, true);

            $send_array['access_token'] = $access['access_token'];

            $send_array['data'][0]['orders'] = $MPID;

            $sendarray = json_encode($send_array, JSON_PRETTY_PRINT);

            $push_url = $api_url.'getAwbNo';

            $response = curl_req($push_url, $sendarray);

            $trackResponse = json_decode($response, true);

            if($trackResponse['IsSuccess'] == 1)
            {
                foreach($trackResponse['Data'] AS $returnresponse){
                    $mpID = $returnresponse['mypacco_order_id'];

                    if(isset($returnresponse['awb_number']))
                    {
                        $order_bouquet = 2;
                        $update = array('supplier_name' => $returnresponse['lsp_name'], 'order_bouquet'=>$order_bouquet, 'awb_number'=>$returnresponse['awb_number']);
                    }else{
                        $rts_date = $wpdb->get_results("SELECT rts_date FROM $table_name WHERE mypacco_order_id = '".$mpID."'");
                        $now = date("Y-m-d H:i:s");
                        $ref = $rts_date[0]->rts_date;
                        $start_date = new DateTime($now);
                        $since_start = $start_date->diff(new DateTime($ref));

                        if($since_start->i > 10){
                            $order_bouquet = 3;
                            $update = array('order_bouquet'=>$order_bouquet);
                        }else{
                            $order_bouquet = 1;
                            $update = array('order_bouquet'=>$order_bouquet);
                        }
                    }

                    /* Update order status */
                    $wpdb->update('wp_mypacco_order_master', $update, array('mypacco_order_id' => $mpID));

                }
            }
        }
        exit;
    }
    /*
    @purpose = This function is used to edit order page
    @author = Rahul Sharma
    @type = External
    */
function mypacco_edit_order()
{
    global $api_url, $wpdb;
    $id = $_GET['id'];
    $decodid = base64_decode($id);

    /* Get Order Data */
    $order_table_name = $wpdb->prefix . "mypacco_order_master";
    $get_order_data = $wpdb->get_results("SELECT * FROM $order_table_name WHERE post_id = ".$decodid." AND status =1");

    /* Get Warehouse Data */
    $ware_table_name = $wpdb->prefix . "mypacco_warehouse";
    $get_ware_data = $wpdb->get_results("SELECT * FROM $ware_table_name");

    //echo $decodid;
    echo '<div class="wrap"><h1>Edit Order</h1>';
    echo '<div style="margin: 8px 0 0;">';
    echo "<form id='edit_order' action='".admin_url('admin-ajax.php')."' method='post'>";
        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
                echo '<div class="panel-body" id="p_scents">';

                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="name">Delivery Name</label>';
                    echo '<input type="text" name="delivery_name" id="delivery_name" value="'.$get_order_data[0]->delivery_fullname.'" class="form-control validate[required]" autofocus>';
                    echo '<input type="hidden" name="order_id" id="order_id" value="'.$get_order_data[0]->order_id.'">';
                    echo '<label for="pincode">Warehouse Name</label>';
                    echo '<select name="warehouse_code" id="warehouse_code" class="form-control validate[required]">';
                    echo '<option value="">-Select-</option>';
                        if(!empty($get_ware_data)){
                        foreach($get_ware_data AS $waredata){
                            if($waredata->warehouse_code == $get_order_data[0]->seller_warehouse_code){
                                $selected = 'selected';
                            }else{$selected = '';}
                            echo '<option '.$selected.' value="'.$waredata->warehouse_code.'">'.$waredata->warehouse_code.'('.$waredata->warehouse_name.')</option>';
                        }	}
                    echo '</select>';
                    echo '<label for="state">Delivery State</label>';
                    echo '<input type="text" name="state" readonly id="state" value="'.$get_order_data[0]->delivery_state.'" class="form-control validate[required]">';


                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="mobile_number">Mobile Number</label>';
                    echo '<input type="text" name="mobile_no" id="mobile_no" value="'.$get_order_data[0]->delivery_mobile.'" class="form-control validate[required,custom[number], maxsize[10]]">';
                    echo '<label for="pincode">Delivery Pincode</label>';
                    echo '<input type="text" name="pincode" id="pincode" value="'.$get_order_data[0]->delivery_pincode.'"  class="form-control validate[required,custom[number],minSize[6]]" maxlength="6">';
                    echo '<label for="country">Delivery Country</label>';
                    echo '<input type="text" name="country" readonly id="country" value="'.$get_order_data[0]->delivery_country.'" class="form-control validate[required]">';
                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="email_id">Delivery Email</label>';
                    echo '<input type="text" name="email_id" id="email_id" value="'.$get_order_data[0]->delivery_email.'" class="form-control validate[required,custom[email]]">';
                    echo '<div id="validationEmailMSG"></div>';
                    echo '<input type="hidden" id="validateEmail" value="0" />';
                    echo '<label for="city">Delivery City</label>';
                    echo '<input type="text" name="city" readonly id="city" value="'.$get_order_data[0]->delivery_city.'" class="form-control validate[required]">';
                    echo '<label for="trans_mode">Transport Mode</label>';
                    echo '<select name="trans_mode" id="trans_mode" class="form-control validate[required,custom[number]]">';
                    if($get_order_data[0]->transport_mode ==1){
                        $selected = "selected";
                    }else if($get_order_data[0]->transport_mode ==2){
                        $selected2 = "selected";
                    }else{
                        $selected = $selected2 = "";
                    }
                    echo '<option value="">-Select-</option>';
                    echo '<option '.$selected.' value="1">Air</option>';
                    echo '<option '.$selected2.' value="2">Surface</option>';
                    echo '</select>';
                    echo '</div>';
                    echo '<div class="form-group col-lg-3">';
                    echo '<label for="add">Delivery Address</label>';
                    echo '<textarea style="resize: none;" id="address" name="address" rows="3" cols="30" class="form-control validate[required]">';
                    echo $get_order_data[0]->delivery_address;
                    echo '</textarea>';
                    echo '<label for="pay_mode">Payment Mode</label>';
                    echo '<select name="pay_mode" id="pay_mode" class="form-control validate[required,custom[number]]">';
                    if($get_order_data[0]->payment_type ==1){
                        $selected = "selected";
                    }else if($get_order_data[0]->payment_type ==2){
                        $selected2 = "selected";
                    }else{
                        $selected = $selected2 = "";
                    }
                    echo '<option value="">-Select-</option>';
                    echo '<option '.$selected.' value="1">Prepaid</option>';
                    echo '<option '.$selected2.' value="2">COD</option>';
                    echo '</select>';
                    echo '</div>';

                echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '</div>';
        /* Item Detail Start Here  */
        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
            echo '<strong>Item Detail</strong>';
                echo '<div class="panel-body" id="p_scents">';
                    /* Get Order Item Data */
                    foreach($get_order_data AS $order_data){
                        $item_table_name = $wpdb->prefix . "mypacco_order_item_master";
                        $get_item_data = $wpdb->get_results("SELECT * FROM $item_table_name WHERE order_id = ".$order_data->order_id);
                        echo '<p class="col-lg-12"><strong>'.$get_item_data[0]->item_title.'</strong></p>';
                        echo '<div class="col-lg-3">';
                        echo '<label for="height">Height</label>';
                        echo '<input type="text" name="height[]" id="height" value="'.$get_item_data[0]->height.'" class="form-control validate[required,custom[number]]">';
                        echo '<input type="hidden" name="item_id[]" id="item_id" value="'.$get_item_data[0]->order_item_id.'">
                              <input type="hidden" name="orderid[]" id="orderid" value="'.$get_item_data[0]->order_id.'">';
                        echo '</div><div class="col-lg-3">';
                        echo '<label for="length">Length</label>';
                        echo '<input type="text" name="length[]" id="length" value="'.$get_item_data[0]->length.'" class="form-control validate[required,custom[number]]">';
                        echo '</div>';
                        echo '<div class="col-lg-3">';
                        echo '<label for="width">Width</label>';
                        echo '<input type="text" name="width[]" id="width" value="'.$get_item_data[0]->width.'" class="form-control validate[required,custom[number]]">';
                        echo '</div><div class="col-lg-3">';
                        echo '<label for="weight">Weight</label>';
                        echo '<input type="text" name="weight[]" id="weight" value="'.$get_item_data[0]->weight.'" class="form-control validate[required,custom[number]]">';
                        echo '</div><div class="col-lg-3">';
                        echo '<label for="total_amount">Base Amount</label>';
                        echo '<input type="text" name="total_amount[]" id="total_amount" value="'.$get_item_data[0]->base_price.'" class="form-control validate[required]">';
                        echo '</div>';
                        echo '<div class="col-lg-3">';
                        echo '<label for="shipp_handling_charges">Shipping Charge</label>';
                        echo '<input type="text" name="shipp_handling_charges[]" id="shipp_handling_charges" value="'.$get_item_data[0]->shipp_handling_charges.'" class="form-control validate[required,custom[number]]">';
                        echo '</div><div class="col-lg-3">';
                        echo '<label for="other_charges">Other Charges</label>';
                        echo '<input type="text" name="other_charges[]" id="other_charges" value="'.$get_item_data[0]->other_charges.'" class="form-control validate[required]">';
                        echo '</div>';
                    }

                echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '</div>';
        /* Item Detail End  */
        echo '<div class="row">';
        echo '<div class="col-lg-12">';
            echo '<section class="panel">';
                echo '<div class="panel-body" id="p_scents">';
                    echo '<div class="col-lg-6">';
                    echo '<div id="validationMSG" style="display:none"></div>';
                    echo '</div>';
                    echo '<div class="col-lg-6" id="msgManageOrder">';
                    echo '<input style="float:right;" type="button" value="Submit" class="btn btn-info" id="editorderbtn" name="editorderbtn"/>';
                    echo '</div>';
                echo '</div>';
            echo '</section>';
        echo '</div>';
        echo '</div>';
    echo "</form>";
    echo '</div>';
    echo '</div>';
}

/* Submit Edit order data */
function edit_order_submit()
{
    global $wpdb;

    $order_id = $_POST['order_id'];
    $name = $_POST['delivery_name'];
    $mobile = $_POST['mobile_no'];
    $email = $_POST['email_id'];
    $pincode = $_POST['pincode'];
    $address = $_POST['address'];
    $city = $_POST['city'];
    $state = $_POST['state'];
    $country = $_POST['country'];
    $warehousename = $_POST['warehouse_code'];
    $trans_mode = $_POST['trans_mode'];
    $pay_mode = $_POST['pay_mode'];

    $countitem = count($_POST['orderid']);

    for($i=0;$i<$countitem; $i++){
        $val_weight = ($_POST['height'][$i] * $_POST['width'][$i] * $_POST['length'][$i])/5000;
        /* Update mypacco_order_master data */
        $update_order = array('delivery_fullname'=>$name,'delivery_mobile'=>$mobile,'delivery_email'=>$email,'delivery_pincode'=>$pincode,'delivery_address'=>$address,'delivery_city'=>$city,'delivery_state'=>$state,'delivery_country'=>$country,'seller_warehouse_code'=>$warehousename,'status'=>1,'order_bouquet'=>0,'transport_mode'=>$trans_mode,'payment_type'=>$pay_mode);
        $wpdb->update('wp_mypacco_order_master', $update_order, array('order_id' => $_POST['orderid'][$i]));

        /* Update mypacco_order_item_master data */
        $table_name = $wpdb->prefix . "mypacco_order_item_master";
        $wpdb->query("UPDATE $table_name SET height=".$_POST['height'][$i].", width =".$_POST['width'][$i].", length=".$_POST['length'][$i].",weight=". $_POST['weight'][$i].",volumetric_weight=".$val_weight.",base_price=".$_POST['total_amount'][$i].",shipp_handling_charges=".$_POST['shipp_handling_charges'][$i].",other_charges=".$_POST['other_charges'][$i]." WHERE order_id =". $_POST['orderid'][$i]);
    }

    $aw_e_msg = '<div class="alert alert-block alert-success fade in" style="width:500px;"><strong>Order Data has been Successfully !!!</strong></div>';

    $resp = array('msg' => 'success', 'html' => $aw_e_msg);
    wp_send_json($resp) ;
    exit;

}
add_action("wp_ajax_edit_order_submit", "edit_order_submit");

/*
    @purpose = This function is used to View order Data
    @author = Rahul Sharma
    @type = External
    */
function mypacco_ajax_view_order()
{
    global $wpdb;
    $id = $_POST['order_id'];

    /* Get Order Data */
    $order_table_name = $wpdb->prefix . "mypacco_order_master";
    $get_order_data = $wpdb->get_results("SELECT * FROM $order_table_name WHERE order_id = ".$id);

    /* Get Order Item Data */
    $item_table_name = $wpdb->prefix . "mypacco_order_item_master";
    if($get_order_data[0]->status == 1){
        $get_item_data = $wpdb->get_results("SELECT * FROM $item_table_name WHERE post_id = ".$get_order_data[0]->post_id);
    }else{
        $get_item_data = $wpdb->get_results("SELECT * FROM $item_table_name WHERE mypacco_order_id = '".$get_order_data[0]->mypacco_order_id."'");
    }


    /* Get Pickup Data */
    $ware_table_name = $wpdb->prefix . "mypacco_warehouse";
    $get_warehouse_data = $wpdb->get_results("SELECT * FROM $ware_table_name WHERE warehouse_code = '".$get_order_data[0]->seller_warehouse_code."'");

    /* Get Order Tracking */
    $track = track_status($get_order_data[0]->mypacco_order_id);
    $html = '';
    $html .= '<table cellpadding="8" cellspacing="5"><div class="panel-heading">Order Tracking Status<span class="tools pull-right"></div>';
    $html .= '<tr><td style="width:150px;"><b>Status</b></td><td style="width:150px;"><b>Localtion</b></td><td style="width:150px;"><b>Date/Time</b></td></tr>';
    if($track['IsSuccess'] == 1)
        {
            foreach($track['Data'] AS $rresponse){

                $AWBNumber = $rresponse['AWBNumber'];
                $mpID = $rresponse['MyPaccoId'];
                $TrackingStatus = $rresponse['TrackingStatus'];
                $lateststatus = array_reverse($TrackingStatus);
                foreach($lateststatus AS $Status){
                    $html .= '<tr>';
                    $html .= '<td>'.$Status['status'].'</td>';
                    $html .= '<td>'.$Status['location'].'</td>';
                    $html .= '<td>'.$Status['date'].'</td>';
                    $html .= '</tr>';
                }
            }
        }else{
            $html .= '<tr><td>No Tracking Found !!</td></tr>';
        }
    $html .= '</table>';
    $html .= '<table cellpadding="8" cellspacing="5"><div class="panel-heading">Order Item Detail<span class="tools pull-right"></div>';
    $html .= '<tr><td style="width:150px;"><b>Item Title</b></td><td style="width:150px;"><b>Weight(Kg.)</b></td><td style="width:150px;"><b>Height(Cm.)</b></td><td style="width:150px;"><b>Width(Cm.)</b></td><td style="width:150px;"><b>Length(Cm.)</b></td><td style="width:150px;"><b>Ship Charge</b></td><td style="width:150px;"><b>Item Amount</b></td></tr>';

    foreach($get_item_data AS $item_data){
        $html .= '<tr>';
        $html .= '<td>'.$item_data->item_title.'</td>';
        $html .= '<td>'.$item_data->weight.'</td>';
        $html .= '<td>'.$item_data->height.'</td>';
        $html .= '<td>'.$item_data->width.'</td>';
        $html .= '<td>'.$item_data->length.'</td>';
        $html .= '<td>'.$item_data->shipp_handling_charges.'</td>';
        $html .= '<td>'.$item_data->base_price.'</td>';
        $html .= '</tr>';
    }
    $html .= '</table>';
    $html .= '<table cellpadding="8" cellspacing="3"><div class="panel-heading">Pickup / Delivery Detail<span class="tools pull-right"></div>';
            $html .= '<tr>';
            $html .= '<td style="width:250px;"><b>Delivery Detail </b></td>';
            $html .= '<td style="width:250px;"><b>Pickup Detail </b></td>';
            $html .= '<td><b>Order Detail </b></td>';
            $html .= '</tr>';
            $html .= '<tr>';
            $html .= '<td><strong>Name : </strong>'.$get_order_data[0]->delivery_fullname.'</td>';
            $html .= '<td><strong>Name : </strong>'.$get_warehouse_data[0]->warehouse_name.'</td>';
            $html .= '<td><strong>Seller Order : </strong>'.$get_order_data[0]->seller_order_number.'</td>';
            $html .= '</tr>';
            $html .= '<tr>';
            $html .= '<td><strong>Mobile : </strong>'.$get_order_data[0]->delivery_mobile.'</td>';
            $html .= '<td><strong>Mobile : </strong>'.$get_warehouse_data[0]->mobile_no.'</td>';
            //$html .= '<td><strong>Mypacco ID : </strong>'.$get_order_data[0]->mypacco_order_id.'</td>';
            $html .= '<td><strong>AWB No. : </strong>'.$get_order_data[0]->awb_number.'</td>';
            $html .= '</tr>';
            $html .= '<tr>';
            $html .= '<td><strong>Email : </strong>'.$get_order_data[0]->delivery_email.'</td>';
            $html .= '<td><strong>Email : </strong>'.$get_warehouse_data[0]->email_id.'</td>';
            $html .= '<td><strong>Status : </strong>'.$get_order_data[0]->status_desc.'</td>';
            $html .= '</tr>';
            $html .= '<tr>';
            $html .= '<td><strong>Address : </strong>'.$get_order_data[0]->delivery_address.'</td>';
            $html .= '<td><strong>Address : </strong>'.$get_warehouse_data[0]->address.'</td>';
            $html .= '<td><strong>Warehouse Name : </strong>'.$get_order_data[0]->seller_warehouse_code.'</td>';
            $html .= '</tr>';
            $html .= '<tr>';
            $html .= '<td><strong>Pincode : </strong>'.$get_order_data[0]->delivery_pincode.'</td>';
            $html .= '<td><strong>Pincode : </strong>'.$get_warehouse_data[0]->pincode.'</td>';
            $html .= '<td><strong>Transport Mode : </strong>'.(($get_order_data[0]->transport_mode == 1)?'Air':'Surface').'</td>';
            $html .= '</tr>';
            $html .= '<tr>';
            $html .= '<td><strong>City : </strong>'.$get_order_data[0]->delivery_city.'</td>';
            $html .= '<td><strong>City : </strong>'.$get_warehouse_data[0]->city.'</td>';
            $html .= '<td><strong>Payment Type : </strong>'.(($get_order_data[0]->payment_type == 1)?'Prepaid':'COD').'</td>';
            $html .= '</tr>';
            $html .= '<tr>';
            $html .= '<td><strong>State : </strong>'.$get_order_data[0]->delivery_state.'</td>';
            $html .= '<td><strong>State : </strong>'.$get_warehouse_data[0]->state.'</td>';

            $html .= '</tr>';
            $html .= '</table>';


    $resp = array('html' => $html);
    wp_send_json($resp) ;
    exit;

}
add_action("wp_ajax_mypacco_ajax_view_order", "mypacco_ajax_view_order");

/* Tracking Order detail */
function track_status($id)
{
    global $api_url, $wpdb;
    $returnresponse = getAccessToken();
    $access = json_decode($returnresponse, true);

    $send_array['access_token'] = $access['access_token'];

    $send_array['data'][0]['tracking_number'] = array($id);

    $sendarray = json_encode($send_array, JSON_PRETTY_PRINT);

    $push_url = $api_url.'trackOrder';

    $response = curl_req($push_url, $sendarray);

    $trackResponse = json_decode($response, true);

    return $trackResponse;
}

/*
    @purpose = This function is used to Cancel order
    @author = Rahul Sharma
    @type = External
    */
function orders_cancel(){
    global $api_url, $wpdb;
    $id = $_POST['order_id'];

    /* Get Order Data */
    $order_table_name = $wpdb->prefix . "mypacco_order_master";
    $get_order_data = $wpdb->get_results("SELECT * FROM $order_table_name WHERE order_id = ".$id);

    /* Call API Add Order method to add order */
    $returnresponse = getAccessToken();
    $access = json_decode($returnresponse, true);

    $send_array['access_token'] = $access['access_token'];

    $send_array['data'][0]['orders'] = array($get_order_data[0]->mypacco_order_id);
    $sendarray = json_encode($send_array, JSON_PRETTY_PRINT);


    $push_url = $api_url.'cancelOrder';

    $response = curl_req($push_url, $sendarray);
    $trackResponse = json_decode($response, true);

    /* Get Mypacco ID */
    if($trackResponse['IsSuccess'] == 1){
        $wpdb->update('wp_mypacco_order_master', array('status'=>7,'status_desc'=>'Order Cancelled'), array('order_id' => $id));

        $resp = array('html' => "Order has been Cancel successfully.");
        wp_send_json($resp);
    }
    exit;

}
add_action("wp_ajax_orders_cancel", "orders_cancel");

/* Get Order Documents */
    function get_document()
    {
        global $api_url, $wpdb;
        if($_GET['id'] == '' || $_GET['id'] == NULL){
            $resp = array('html' => 'Please Select Order !!');
            wp_send_json($resp);
            exit;
        }
        $ids = str_replace("on-","",$_GET['id']);

        $final_order_ids = trim($ids, "-");

        $final_ids = str_replace("-",",",$final_order_ids);
        /* Get Order Data */
        $order_table_name = $wpdb->prefix . "mypacco_order_master";
        $get_order_data = $wpdb->get_results("SELECT * FROM $order_table_name WHERE order_id IN (".$final_ids.")");

        /* Get MypaccoID */
        $MPID = array();

        foreach($get_order_data as $order_data)
        {
            $MPID[] = $order_data->mypacco_order_id;
        }

        /* Call API getDocs method to get Order Documents */
        $returnresponse = getAccessToken();
        $access = json_decode($returnresponse, true);
        $send_array['access_token'] = $access['access_token'];

        $send_array['data'][0]['orders'] = $MPID;
        $sendarray = json_encode($send_array, JSON_PRETTY_PRINT);

        $push_url = $api_url.'getDocs';

        $response = curl_req($push_url, $sendarray);
        $stringWithFile = $response;
        header('Content-Type:application/pdf');
        header('Content-Disposition:attachment;filename=mypacco_documents.pdf');

        file_put_contents("mypacco_documents.pdf", $stringWithFile);

        @readfile('mypacco_documents.pdf');

    }
add_action("wp_ajax_get_document", "get_document");
